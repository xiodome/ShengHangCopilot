<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªäººä¸­å¿ƒ - å£°èˆªéŸ³ä¹</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <a href="index.html" class="logo">ğŸµ å£°èˆªéŸ³ä¹</a>
        <div class="nav-links">
            <a href="index.html">é¦–é¡µ</a>
            <a href="music.html">éŸ³ä¹ä¸­å¿ƒ</a>
            <a href="songlist.html">æˆ‘çš„æ­Œå•</a>
            <a href="favorites.html">æˆ‘çš„æ”¶è—</a>
            <a href="history.html">æ’­æ”¾è®°å½•</a>
            <a href="profile.html" class="active">ä¸ªäººä¸­å¿ƒ</a>
            <span id="adminLink" style="display: none;"><a href="admin.html">ç®¡ç†åå°</a></span>
        </div>
        <div class="user-info">
            <span id="welcomeText">åŠ è½½ä¸­...</span>
            <button class="logout-btn" onclick="handleLogout()">é€€å‡ºç™»å½•</button>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹ -->
    <div class="container">
        <div id="alertBox"></div>
        
        <!-- æ ‡ç­¾é¡µ -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('profile')">ğŸ‘¤ ä¸ªäººèµ„æ–™</button>
            <button class="tab" onclick="switchTab('password')">ğŸ” ä¿®æ”¹å¯†ç </button>
            <button class="tab" onclick="switchTab('follow')">ğŸ‘¥ å…³æ³¨ç®¡ç†</button>
            <button class="tab" onclick="switchTab('comments')">ğŸ’¬ æˆ‘çš„è¯„è®º</button>
            <button class="tab" onclick="switchTab('searchUser')">ğŸ” æœç´¢ç”¨æˆ·</button>
        </div>
        
        <!-- ä¸ªäººèµ„æ–™é¢æ¿ -->
        <div id="profilePanel">
            <div class="card">
                <h3 class="card-title">ğŸ‘¤ ä¸ªäººèµ„æ–™</h3>
                <div id="profileContent" class="loading">
                    <div class="spinner"></div>
                    <p>åŠ è½½ä¸­...</p>
                </div>
            </div>
            
            <div class="card">
                <h3 class="card-title">âœï¸ ç¼–è¾‘èµ„æ–™</h3>
                <form id="profileForm">
                    <div class="form-group">
                        <label>æ€§åˆ«</label>
                        <select id="editGender">
                            <option value="ç”·">ç”·</option>
                            <option value="å¥³">å¥³</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ç”Ÿæ—¥</label>
                        <input type="date" id="editBirthday">
                    </div>
                    <div class="form-group">
                        <label>åœ°åŒº</label>
                        <input type="text" id="editRegion" placeholder="è¯·è¾“å…¥æ‰€åœ¨åœ°åŒº">
                    </div>
                    <div class="form-group">
                        <label>é‚®ç®±</label>
                        <input type="email" id="editEmail" placeholder="è¯·è¾“å…¥é‚®ç®±">
                    </div>
                    <div class="form-group">
                        <label>ä¸ªäººç®€ä»‹</label>
                        <textarea id="editProfile" placeholder="ä»‹ç»ä¸€ä¸‹è‡ªå·±å§..." style="height: 100px;"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">ä¿å­˜ä¿®æ”¹</button>
                </form>
            </div>
            
            <div class="card">
                <h3 class="card-title">ğŸ”’ éšç§è®¾ç½®</h3>
                <form id="visibilityForm">
                    <div class="form-group">
                        <label>ä¸ªäººä¿¡æ¯å¯è§æ€§</label>
                        <select id="visibilitySetting">
                            <option value="å…¨éƒ¨äººå¯è§">å…¨éƒ¨äººå¯è§</option>
                            <option value="ä»…å…³æ³¨è€…å¯è§">ä»…å…³æ³¨è€…å¯è§</option>
                            <option value="ç§å¯†">ç§å¯†</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">ä¿å­˜éšç§è®¾ç½®</button>
                </form>
            </div>
            
            <div class="card" style="border: 1px solid #e74c3c;">
                <h3 class="card-title" style="color: #e74c3c;">âš ï¸ å±é™©æ“ä½œ</h3>
                <p style="color: #666; margin-bottom: 15px;">æ³¨é”€è´¦å·åï¼Œæ‚¨çš„æ‰€æœ‰æ•°æ®å°†è¢«æ°¸ä¹…åˆ é™¤ä¸”æ— æ³•æ¢å¤ã€‚</p>
                <button class="btn btn-danger" onclick="showDeleteAccountModal()">æ³¨é”€è´¦å·</button>
            </div>
        </div>
        
        <!-- ä¿®æ”¹å¯†ç é¢æ¿ -->
        <div id="passwordPanel" style="display: none;">
            <div class="card">
                <h3 class="card-title">ğŸ” ä¿®æ”¹å¯†ç </h3>
                <form id="passwordForm">
                    <div class="form-group">
                        <label>å½“å‰å¯†ç </label>
                        <input type="password" id="oldPassword" placeholder="è¯·è¾“å…¥å½“å‰å¯†ç " required>
                    </div>
                    <div class="form-group">
                        <label>æ–°å¯†ç </label>
                        <input type="password" id="newPassword" placeholder="è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰" required minlength="6">
                    </div>
                    <div class="form-group">
                        <label>ç¡®è®¤æ–°å¯†ç </label>
                        <input type="password" id="confirmNewPassword" placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç " required>
                    </div>
                    <button type="submit" class="btn btn-primary">ä¿®æ”¹å¯†ç </button>
                </form>
            </div>
        </div>
        
        <!-- å…³æ³¨ç®¡ç†é¢æ¿ -->
        <div id="followPanel" style="display: none;">
            <div class="grid" style="grid-template-columns: repeat(3, 1fr);">
                <div class="card">
                    <h3 class="card-title">ğŸ‘¥ æˆ‘çš„å…³æ³¨</h3>
                    <div id="followingsList" class="loading">
                        <div class="spinner"></div>
                        <p>åŠ è½½ä¸­...</p>
                    </div>
                </div>
                <div class="card">
                    <h3 class="card-title">â¤ï¸ æˆ‘çš„ç²‰ä¸</h3>
                    <div id="followersList" class="loading">
                        <div class="spinner"></div>
                        <p>åŠ è½½ä¸­...</p>
                    </div>
                </div>
                <div class="card">
                    <h3 class="card-title">ğŸ¤ å…³æ³¨çš„æ­Œæ‰‹</h3>
                    <div id="singersList" class="loading">
                        <div class="spinner"></div>
                        <p>åŠ è½½ä¸­...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æˆ‘çš„è¯„è®ºé¢æ¿ -->
        <div id="commentsPanel" style="display: none;">
            <div class="card">
                <h3 class="card-title">ğŸ’¬ æˆ‘çš„è¯„è®º</h3>
                <div id="commentsList" class="loading">
                    <div class="spinner"></div>
                    <p>åŠ è½½ä¸­...</p>
                </div>
            </div>
        </div>
        
        <!-- æœç´¢ç”¨æˆ·é¢æ¿ -->
        <div id="searchUserPanel" style="display: none;">
            <div class="card">
                <h3 class="card-title">ğŸ” æœç´¢ç”¨æˆ·</h3>
                <div class="form-group">
                    <label>ç”¨æˆ·å</label>
                    <input type="text" id="searchUsername" placeholder="è¾“å…¥ç”¨æˆ·åè¿›è¡Œæœç´¢">
                </div>
                <button class="btn btn-primary" onclick="searchUser()">æœç´¢</button>
                <div id="searchResults" style="margin-top: 20px;"></div>
            </div>
            
            <!-- ç”¨æˆ·è¯¦æƒ… -->
            <div class="card" id="userDetailCard" style="display: none;">
                <button class="btn btn-secondary" onclick="closeUserDetail()" style="margin-bottom: 15px;">â† è¿”å›æœç´¢</button>
                <div id="userDetailContent"></div>
            </div>
        </div>
    </div>
    
    <!-- æ³¨é”€è´¦å·æ¨¡æ€æ¡† -->
    <div class="modal" id="deleteAccountModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>âš ï¸ ç¡®è®¤æ³¨é”€è´¦å·</h2>
                <button class="modal-close" onclick="closeDeleteAccountModal()">&times;</button>
            </div>
            <p style="color: #666; margin-bottom: 20px;">æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼è¯·è¾“å…¥å¯†ç ç¡®è®¤æ³¨é”€ï¼š</p>
            <form id="deleteAccountForm">
                <div class="form-group">
                    <label>å¯†ç </label>
                    <input type="password" id="deletePassword" placeholder="è¯·è¾“å…¥å¯†ç " required>
                </div>
                <button type="submit" class="btn btn-danger">ç¡®è®¤æ³¨é”€</button>
                <button type="button" class="btn btn-secondary" onclick="closeDeleteAccountModal()">å–æ¶ˆ</button>
            </form>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        if (!UserStore.isLoggedIn()) {
            window.location.href = 'login.html';
        }
        
        let currentTab = 'profile';
        let viewingUserId = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('welcomeText').textContent = 'æ¬¢è¿ï¼Œ' + UserStore.getUsername();

            if (UserStore.isAdmin()) {
                document.getElementById('adminLink').style.display = 'inline';
            }

            // æ£€æŸ¥URLå‚æ•°ï¼Œæ˜¯å¦è¦æŸ¥çœ‹å…¶ä»–ç”¨æˆ·
            const params = new URLSearchParams(window.location.search);
            const userId = params.get('user_id');
            
            if (userId && userId != UserStore.getUserId()) {
                viewingUserId = userId;
                switchTab('searchUser');
                viewUserDetail(userId);
            } else {
                loadProfile();
            }
        });
        
        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tab) {
            currentTab = tab;
            
            // æ›´æ–°æ ‡ç­¾æ ·å¼
            document.querySelectorAll('.tab').forEach((t, index) => {
                t.classList.remove('active');
                if ((tab === 'profile' && index === 0) ||
                    (tab === 'password' && index === 1) ||
                    (tab === 'follow' && index === 2) ||
                    (tab === 'comments' && index === 3) ||
                    (tab === 'searchUser' && index === 4)) {
                    t.classList.add('active');
                }
            });
            
            // éšè—æ‰€æœ‰é¢æ¿
            document.getElementById('profilePanel').style.display = 'none';
            document.getElementById('passwordPanel').style.display = 'none';
            document.getElementById('followPanel').style.display = 'none';
            document.getElementById('commentsPanel').style.display = 'none';
            document.getElementById('searchUserPanel').style.display = 'none';
            
            // æ˜¾ç¤ºå¯¹åº”é¢æ¿
            document.getElementById(tab + 'Panel').style.display = 'block';
            
            // åŠ è½½æ•°æ®
            switch (tab) {
                case 'profile':
                    loadProfile();
                    break;
                case 'follow':
                    loadFollowData();
                    break;
                case 'comments':
                    loadComments();
                    break;
            }
        }
        
        // åŠ è½½ä¸ªäººèµ„æ–™
        async function loadProfile() {
            const container = document.getElementById('profileContent');
            const userId = UserStore.getUserId();
            
            try {
                const profile = await UserAPI.getProfile(userId);
                
                container.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div><strong>ç”¨æˆ·åï¼š</strong>${profile.username}</div>
                        <div><strong>æ€§åˆ«ï¼š</strong>${profile.gender || 'æœªè®¾ç½®'}</div>
                        <div><strong>ç”Ÿæ—¥ï¼š</strong>${profile.birthday || 'æœªè®¾ç½®'}</div>
                        <div><strong>åœ°åŒºï¼š</strong>${profile.region || 'æœªè®¾ç½®'}</div>
                        <div><strong>é‚®ç®±ï¼š</strong>${profile.email || 'æœªè®¾ç½®'}</div>
                    </div>
                    <div style="margin-top: 15px;">
                        <strong>ä¸ªäººç®€ä»‹ï¼š</strong>
                        <p style="color: #666; margin-top: 5px;">${profile.profile || 'è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡ç•™ä¸‹...'}</p>
                    </div>
                `;
                
                // å¡«å……ç¼–è¾‘è¡¨å•
                if (profile.gender) document.getElementById('editGender').value = profile.gender;
                if (profile.birthday) document.getElementById('editBirthday').value = profile.birthday;
                if (profile.region) document.getElementById('editRegion').value = profile.region;
                if (profile.email) document.getElementById('editEmail').value = profile.email;
                if (profile.profile) document.getElementById('editProfile').value = profile.profile;
                
            } catch (error) {
                container.innerHTML = `<div class="alert alert-error">${error.error || 'åŠ è½½å¤±è´¥'}</div>`;
            }
        }
        
        // ç¼–è¾‘èµ„æ–™è¡¨å•æäº¤
        document.getElementById('profileForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const data = {};
            const gender = document.getElementById('editGender').value;
            const birthday = document.getElementById('editBirthday').value;
            const region = document.getElementById('editRegion').value.trim();
            const email = document.getElementById('editEmail').value.trim();
            const profile = document.getElementById('editProfile').value.trim();
            
            if (gender) data.gender = gender;
            if (birthday) data.birthday = birthday;
            if (region) data.region = region;
            if (email) data.email = email;
            if (profile) data.profile = profile;
            
            try {
                await UserAPI.updateProfile(data);
                showAlert('èµ„æ–™ä¿®æ”¹æˆåŠŸï¼', 'success');
                loadProfile();
            } catch (error) {
                showAlert(error.error || 'ä¿®æ”¹å¤±è´¥', 'error');
            }
        });
        
        // ä¿®æ”¹å¯†ç è¡¨å•æäº¤
        document.getElementById('passwordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;
            
            if (newPassword.length < 6) {
                showAlert('æ–°å¯†ç é•¿åº¦è‡³å°‘ä¸º6ä½', 'error');
                return;
            }
            
            if (newPassword !== confirmNewPassword) {
                showAlert('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´', 'error');
                return;
            }
            
            try {
                await UserAPI.changePassword(oldPassword, newPassword);
                showAlert('å¯†ç ä¿®æ”¹æˆåŠŸï¼', 'success');
                document.getElementById('passwordForm').reset();
            } catch (error) {
                showAlert(error.error || 'ä¿®æ”¹å¤±è´¥', 'error');
            }
        });
        
        // åŠ è½½å…³æ³¨æ•°æ®
        async function loadFollowData() {
            const userId = UserStore.getUserId();
            
            // åŠ è½½å…³æ³¨åˆ—è¡¨
            loadFollowings(userId);
            loadFollowers(userId);
            loadFollowSingers(userId);
        }
        
        async function loadFollowings(userId) {
            const container = document.getElementById('followingsList');
            
            try {
                const result = await UserAPI.getFollowings(userId);
                
                if (!result.followings || result.followings.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>è¿˜æ²¡æœ‰å…³æ³¨ä»»ä½•äºº</p></div>';
                } else {
                    container.innerHTML = `
                        <p style="color: #888; margin-bottom: 10px;">å…± ${result.total_count} äºº</p>
                        ${result.followings.map(user => `
                            <div class="song-item" style="padding: 10px 0;">
                                <div class="song-info">
                                    <div class="song-title">${user.user_name}</div>
                                </div>
                                <button class="btn btn-small btn-danger" onclick="unfollowUser(${user.user_id})">å–æ¶ˆå…³æ³¨</button>
                            </div>
                        `).join('')}
                    `;
                }
            } catch (error) {
                container.innerHTML = `<div class="alert alert-error">${error.error || 'åŠ è½½å¤±è´¥'}</div>`;
            }
        }
        
        async function loadFollowers(userId) {
            const container = document.getElementById('followersList');
            
            try {
                const result = await UserAPI.getFollowers(userId);
                
                if (!result.followers || result.followers.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>è¿˜æ²¡æœ‰ç²‰ä¸</p></div>';
                } else {
                    container.innerHTML = `
                        <p style="color: #888; margin-bottom: 10px;">å…± ${result.total_count} äºº</p>
                        ${result.followers.map(user => `
                            <div class="song-item" style="padding: 10px 0;">
                                <div class="song-info">
                                    <div class="song-title">${user.user_name}</div>
                                </div>
                                <button class="btn btn-small btn-secondary" onclick="followUser(${user.user_id})">å…³æ³¨TA</button>
                            </div>
                        `).join('')}
                    `;
                }
            } catch (error) {
                container.innerHTML = `<div class="alert alert-error">${error.error || 'åŠ è½½å¤±è´¥'}</div>`;
            }
        }
        
        async function loadFollowSingers(userId) {
            const container = document.getElementById('singersList');
            
            try {
                const result = await UserAPI.getFollowSingers(userId);
                
                if (!result.follow_singers || result.follow_singers.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>è¿˜æ²¡æœ‰å…³æ³¨æ­Œæ‰‹</p></div>';
                } else {
                    container.innerHTML = `
                        <p style="color: #888; margin-bottom: 10px;">å…± ${result.total_count} äºº</p>
                        ${result.follow_singers.map(singer => `
                            <div class="song-item" style="padding: 10px 0;">
                                <div class="song-info">
                                    <div class="song-title">${singer.singer_name}</div>
                                </div>
                                <button class="btn btn-small btn-danger" onclick="unfollowSinger(${singer.singer_id})">å–æ¶ˆå…³æ³¨</button>
                            </div>
                        `).join('')}
                    `;
                }
            } catch (error) {
                container.innerHTML = `<div class="alert alert-error">${error.error || 'åŠ è½½å¤±è´¥'}</div>`;
            }
        }
        
        // å…³æ³¨/å–å…³æ“ä½œ
        async function followUser(userId) {
            try {
                await UserAPI.followUser(userId);
                showAlert('å…³æ³¨æˆåŠŸï¼', 'success');
                loadFollowData();
            } catch (error) {
                showAlert(error.error || 'å…³æ³¨å¤±è´¥', 'error');
            }
        }
        
        async function unfollowUser(userId) {
            try {
                await UserAPI.unfollowUser(userId);
                showAlert('å–æ¶ˆå…³æ³¨æˆåŠŸï¼', 'success');
                loadFollowData();
            } catch (error) {
                showAlert(error.error || 'å–æ¶ˆå…³æ³¨å¤±è´¥', 'error');
            }
        }
        
        async function unfollowSinger(singerId) {
            try {
                await UserAPI.unfollowSinger(singerId);
                showAlert('å–æ¶ˆå…³æ³¨æˆåŠŸï¼', 'success');
                loadFollowData();
            } catch (error) {
                showAlert(error.error || 'å–æ¶ˆå…³æ³¨å¤±è´¥', 'error');
            }
        }
        
        // åŠ è½½è¯„è®º
        async function loadComments() {
            const container = document.getElementById('commentsList');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>åŠ è½½ä¸­...</p></div>';
            
            try {
                const result = await CommentAPI.listComments();
                
                const allComments = [];
                
                // æ­Œæ›²è¯„è®º
                if (result.songs && result.songs.comments) {
                    result.songs.comments.forEach(c => {
                        allComments.push({ ...c, type: 'æ­Œæ›²', typeId: c.song_id });
                    });
                }
                
                // ä¸“è¾‘è¯„è®º
                if (result.albums && result.albums.comments) {
                    result.albums.comments.forEach(c => {
                        allComments.push({ ...c, type: 'ä¸“è¾‘', typeId: c.album_id });
                    });
                }
                
                // æ­Œå•è¯„è®º
                if (result.songlists && result.songlists.comments) {
                    result.songlists.comments.forEach(c => {
                        allComments.push({ ...c, type: 'æ­Œå•', typeId: c.songlist_id });
                    });
                }
                
                if (allComments.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">ğŸ’¬</div>
                            <p>è¿˜æ²¡æœ‰å‘è¡¨è¿‡è¯„è®º</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <p style="color: #888; margin-bottom: 15px;">å…± ${allComments.length} æ¡è¯„è®º</p>
                        ${allComments.map(comment => `
                            <div class="comment-item" style="cursor: pointer;" onclick="goToCommentTarget('${comment.type}', ${comment.typeId})">
                                <div class="comment-header">
                                    <span style="background: #667eea; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px;">${comment.type}</span>
                                    <span class="time">${comment.comment_time}</span>
                                </div>
                                <div class="content">${comment.content}</div>
                                <div class="actions">
                                    <span>ğŸ‘ ${comment.like_count}</span>
                                    <button onclick="event.stopPropagation(); deleteComment(${comment.comment_id})">ğŸ—‘ï¸ åˆ é™¤</button>
                                </div>
                            </div>
                        `).join('')}
                    `;
                }
            } catch (error) {
                container.innerHTML = `<div class="alert alert-error">${error.error || 'åŠ è½½å¤±è´¥'}</div>`;
            }
        }
        
        // åˆ é™¤è¯„è®º
        async function deleteComment(commentId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ')) {
                return;
            }
            
            try {
                await CommentAPI.deleteComment(commentId);
                showAlert('è¯„è®ºåˆ é™¤æˆåŠŸï¼', 'success');
                loadComments();
            } catch (error) {
                showAlert(error.error || 'åˆ é™¤å¤±è´¥', 'error');
            }
        }
        
        // ç‚¹å‡»è¯„è®ºè·³è½¬åˆ°å¯¹åº”è¯¦æƒ…é¡µ
        function goToCommentTarget(type, targetId) {
            if (type === 'æ­Œæ›²') {
                window.location.href = `music.html?type=song&id=${targetId}`;
            } else if (type === 'ä¸“è¾‘') {
                window.location.href = `music.html?type=album&id=${targetId}`;
            } else if (type === 'æ­Œå•') {
                window.location.href = `songlist.html?id=${targetId}`;
            }
        }
        
        // æ³¨é”€è´¦å·
        function showDeleteAccountModal() {
            document.getElementById('deleteAccountModal').classList.add('active');
        }
        
        function closeDeleteAccountModal() {
            document.getElementById('deleteAccountModal').classList.remove('active');
            document.getElementById('deleteAccountForm').reset();
        }
        
        document.getElementById('deleteAccountForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const password = document.getElementById('deletePassword').value;
            
            try {
                await UserAPI.deleteAccount(password);
                showAlert('è´¦å·å·²æ³¨é”€', 'success');
                UserStore.clearUser();
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 1500);
            } catch (error) {
                showAlert(error.error || 'æ³¨é”€å¤±è´¥', 'error');
            }
        });
        
        // éšç§è®¾ç½®è¡¨å•æäº¤
        document.getElementById('visibilityForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const visibility = document.getElementById('visibilitySetting').value;
            
            try {
                await UserAPI.updateVisibility({ visibility: visibility });
                showAlert('éšç§è®¾ç½®å·²ä¿å­˜ï¼', 'success');
            } catch (error) {
                showAlert(error.error || 'ä¿å­˜å¤±è´¥', 'error');
            }
        });
        
        // æœç´¢ç”¨æˆ·
        async function searchUser() {
            const username = document.getElementById('searchUsername').value.trim();
            if (!username) {
                showAlert('è¯·è¾“å…¥ç”¨æˆ·å', 'error');
                return;
            }
            
            const container = document.getElementById('searchResults');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>æœç´¢ä¸­...</p></div>';
            
            try {
                const result = await UserAPI.getUserInfo(username);
                if (result.user_id) {
                    container.innerHTML = `
                        <div class="song-item" style="padding: 15px; cursor: pointer;" onclick="viewUserDetail(${result.user_id})">
                            <div class="song-info">
                                <div class="song-title">${result.user_name}</div>
                                <div class="song-meta">ç”¨æˆ·ID: ${result.user_id}</div>
                            </div>
                            <button class="btn btn-small btn-primary" onclick="event.stopPropagation(); followUser(${result.user_id})">å…³æ³¨</button>
                        </div>
                    `;
                } else {
                    container.innerHTML = '<p style="color: #888; text-align: center;">æœªæ‰¾åˆ°ç”¨æˆ·</p>';
                }
            } catch (error) {
                container.innerHTML = `<div class="alert alert-error">${error.error || 'æœç´¢å¤±è´¥'}</div>`;
            }
        }
        
        // æŸ¥çœ‹ç”¨æˆ·è¯¦æƒ…
        async function viewUserDetail(userId) {
            const container = document.getElementById('userDetailContent');
            document.getElementById('userDetailCard').style.display = 'block';
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>åŠ è½½ä¸­...</p></div>';
            
            try {
                const profile = await UserAPI.getProfile(userId);
                
                const isOwner = profile.is_owner;
                
                container.innerHTML = `
                    <h2 style="margin-bottom: 20px;">ğŸ‘¤ ${profile.username}</h2>
                    <div style="margin-bottom: 20px;">
                        <p><strong>ç”¨æˆ·ID:</strong> ${profile.user_id}</p>
                        ${profile.gender ? `<p><strong>æ€§åˆ«:</strong> ${profile.gender}</p>` : ''}
                        ${profile.birthday ? `<p><strong>ç”Ÿæ—¥:</strong> ${profile.birthday}</p>` : ''}
                        ${profile.region ? `<p><strong>åœ°åŒº:</strong> ${profile.region}</p>` : ''}
                        ${profile.email ? `<p><strong>é‚®ç®±:</strong> ${profile.email}</p>` : ''}
                        ${profile.profile ? `<p><strong>ç®€ä»‹:</strong> ${profile.profile}</p>` : '<p style="color: #888;">è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡ç•™ä¸‹...</p>'}
                    </div>
                    ${!isOwner ? `
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="followUser(${profile.user_id})">â• å…³æ³¨</button>
                        <button class="btn btn-secondary" onclick="unfollowUser(${profile.user_id})">â– å–æ¶ˆå…³æ³¨</button>
                    </div>
                    ` : ''}
                `;
            } catch (error) {
                container.innerHTML = `<div class="alert alert-error">${error.error || 'æ— æ³•æŸ¥çœ‹æ­¤ç”¨æˆ·ä¿¡æ¯'}</div>`;
            }
        }
        
        // å…³é—­ç”¨æˆ·è¯¦æƒ…
        function closeUserDetail() {
            document.getElementById('userDetailCard').style.display = 'none';
            viewingUserId = null;
        }
        
        function showAlert(message, type) {
            const alertBox = document.getElementById('alertBox');
            alertBox.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => alertBox.innerHTML = '', 3000);
        }
    </script>
</body>
</html>
