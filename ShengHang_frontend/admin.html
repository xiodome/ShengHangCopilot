<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†åå° - å£°èˆªéŸ³ä¹</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <a href="index.html" class="logo">ğŸµ å£°èˆªéŸ³ä¹</a>
        <div class="nav-links">
            <a href="index.html">é¦–é¡µ</a>
            <a href="music.html">éŸ³ä¹ä¸­å¿ƒ</a>
            <a href="songlist.html">æˆ‘çš„æ­Œå•</a>
            <a href="favorites.html">æˆ‘çš„æ”¶è—</a>
            <a href="history.html">æ’­æ”¾è®°å½•</a>
            <a href="profile.html">ä¸ªäººä¸­å¿ƒ</a>
            <a href="admin.html" class="active">ç®¡ç†åå°</a>
        </div>
        <div class="user-info">
            <span id="welcomeText">åŠ è½½ä¸­...</span>
            <button class="logout-btn" onclick="handleLogout()">é€€å‡ºç™»å½•</button>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹ -->
    <div class="container">
        <div id="alertBox"></div>
        
        <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <h2>ğŸ› ï¸ ç®¡ç†å‘˜åå°</h2>
            <p style="margin-top: 10px; opacity: 0.9;">æ¬¢è¿ç®¡ç†å‘˜ï¼æ‚¨å¯ä»¥åœ¨æ­¤ç®¡ç†æ­Œæ‰‹ã€ä¸“è¾‘å’Œæ­Œæ›²ä¿¡æ¯ã€‚</p>
        </div>
        
        <!-- æ ‡ç­¾é¡µ -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('singer')">ğŸ¤ æ·»åŠ æ­Œæ‰‹</button>
            <button class="tab" onclick="switchTab('logs')">ğŸ“‹ ç³»ç»Ÿæ—¥å¿—</button>
            <button class="tab" onclick="switchTab('stats')">ğŸ“Š ç”¨æˆ·ç»Ÿè®¡</button>
            <button class="tab" onclick="switchTab('comments')">ğŸ’¬ è¯„è®ºå®¡æ ¸</button>
        </div>
        
        <!-- æ­Œæ‰‹ç®¡ç†é¢æ¿ (åªä¿ç•™æ·»åŠ åŠŸèƒ½) -->
        <div id="singerPanel">
            <div class="card">
                <h3 class="card-title">â• æ·»åŠ æ­Œæ‰‹</h3>
                <p style="color: #666; margin-bottom: 15px;">ğŸ’¡ æç¤ºï¼šæ­Œæ‰‹çš„åˆ é™¤å’Œä¿®æ”¹è¯·åˆ°éŸ³ä¹ä¸­å¿ƒå¯¹åº”æ­Œæ‰‹è¯¦æƒ…é¡µè¿›è¡Œæ“ä½œ</p>
                <form id="addSingerForm">
                    <div class="form-group">
                        <label>æ­Œæ‰‹åç§° *</label>
                        <input type="text" id="singerName" placeholder="è¯·è¾“å…¥æ­Œæ‰‹åç§°" required>
                    </div>
                    <div class="form-group">
                        <label>æ­Œæ‰‹ç±»å‹ *</label>
                        <select id="singerType" required>
                            <option value="ç”·">ç”·</option>
                            <option value="å¥³">å¥³</option>
                            <option value="ç»„åˆ">ç»„åˆ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>å›½ç±</label>
                        <input type="text" id="singerCountry" placeholder="è¯·è¾“å…¥å›½ç±">
                    </div>
                    <div class="form-group">
                        <label>ç”Ÿæ—¥</label>
                        <input type="date" id="singerBirthday">
                    </div>
                    <div class="form-group">
                        <label>æ­Œæ‰‹ç®€ä»‹</label>
                        <textarea id="singerIntroduction" placeholder="è¯·è¾“å…¥æ­Œæ‰‹ç®€ä»‹" style="height: 100px;"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">æ·»åŠ æ­Œæ‰‹</button>
                </form>
            </div>
        </div>
        
        <!-- ç³»ç»Ÿæ—¥å¿—é¢æ¿ -->
        <div id="logsPanel" style="display: none;">
            <div class="card">
                <h3 class="card-title">ğŸ“‹ ç³»ç»Ÿæ—¥å¿—</h3>
                <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <select id="logTableFilter">
                        <option value="">å…¨éƒ¨è¡¨</option>
                        <option value="Singer">æ­Œæ‰‹</option>
                        <option value="Album">ä¸“è¾‘</option>
                        <option value="Song">æ­Œæ›²</option>
                        <option value="User">ç”¨æˆ·</option>
                        <option value="Comment">è¯„è®º</option>
                    </select>
                    <select id="logResultFilter">
                        <option value="">å…¨éƒ¨ç»“æœ</option>
                        <option value="success">æˆåŠŸ</option>
                        <option value="fail">å¤±è´¥</option>
                    </select>
                    <input type="text" id="logKeyword" placeholder="æœç´¢å…³é”®è¯" style="flex: 1;">
                    <button class="btn btn-primary" onclick="loadSystemLogs()">æœç´¢</button>
                </div>
                <div id="logsContent">
                    <p style="color: #888; text-align: center;">ç‚¹å‡»æœç´¢æŸ¥çœ‹æ—¥å¿—</p>
                </div>
                <div id="logsPagination" style="margin-top: 15px; text-align: center;"></div>
            </div>
        </div>
        
        <!-- ç”¨æˆ·ç»Ÿè®¡é¢æ¿ -->
        <div id="statsPanel" style="display: none;">
            <div class="card">
                <h3 class="card-title">ğŸ“Š ç”¨æˆ·è¡Œä¸ºç»Ÿè®¡</h3>
                <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center;">
                    <label>æ—¶é—´èŒƒå›´ï¼š</label>
                    <input type="date" id="statsStartDate">
                    <span>è‡³</span>
                    <input type="date" id="statsEndDate">
                    <button class="btn btn-primary" onclick="loadUserStats()">æŸ¥è¯¢</button>
                </div>
                <div id="statsContent">
                    <p style="color: #888; text-align: center;">ç‚¹å‡»æŸ¥è¯¢è·å–ç»Ÿè®¡æ•°æ®</p>
                </div>
            </div>
        </div>
        
        <!-- è¯„è®ºå®¡æ ¸é¢æ¿ -->
        <div id="commentsPanel" style="display: none;">
            <div class="card">
                <h3 class="card-title">ğŸ’¬ å¾…å®¡æ ¸è¯„è®º</h3>
                <button class="btn btn-secondary" onclick="loadPendingComments()" style="margin-bottom: 15px;">åˆ·æ–°åˆ—è¡¨</button>
                <div id="pendingComments">
                    <p style="color: #888; text-align: center;">åŠ è½½ä¸­...</p>
                </div>
                <div id="commentsPagination" style="margin-top: 15px; text-align: center;"></div>
            </div>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        // æ£€æŸ¥ç™»å½•çŠ¶æ€å’Œç®¡ç†å‘˜æƒé™
        // æ³¨æ„ï¼šè¿™åªæ˜¯å‰ç«¯UIä¿æŠ¤ï¼Œæ‰€æœ‰ç®¡ç†å‘˜æ“ä½œéƒ½å¿…é¡»åœ¨åç«¯è¿›è¡Œæƒé™éªŒè¯
        // åç«¯çš„ require_admin() å‡½æ•°ä¼šéªŒè¯å®é™…çš„ç®¡ç†å‘˜æƒé™
        if (!UserStore.isLoggedIn()) {
            window.location.href = 'login.html';
        }
        
        if (!UserStore.isAdmin()) {
            alert('æ‚¨æ²¡æœ‰ç®¡ç†å‘˜æƒé™ï¼');
            window.location.href = 'index.html';
        }
        
        let currentTab = 'singer';
        
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('welcomeText').textContent = 'ç®¡ç†å‘˜ï¼š' + UserStore.getUsername();
        });
        
        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tab) {
            currentTab = tab;
            
            // æ›´æ–°æ ‡ç­¾æ ·å¼
            document.querySelectorAll('.tab').forEach((t, index) => {
                t.classList.remove('active');
                if ((tab === 'singer' && index === 0) ||
                    (tab === 'logs' && index === 1) ||
                    (tab === 'stats' && index === 2) ||
                    (tab === 'comments' && index === 3)) {
                    t.classList.add('active');
                }
            });
            
            // éšè—æ‰€æœ‰é¢æ¿
            document.getElementById('singerPanel').style.display = 'none';
            document.getElementById('logsPanel').style.display = 'none';
            document.getElementById('statsPanel').style.display = 'none';
            document.getElementById('commentsPanel').style.display = 'none';
            
            // æ˜¾ç¤ºå¯¹åº”é¢æ¿
            document.getElementById(tab + 'Panel').style.display = 'block';
            
            // åŠ è½½æ•°æ®
            if (tab === 'logs') loadSystemLogs();
            if (tab === 'stats') initStatsDateRange();
            if (tab === 'comments') loadPendingComments();
        }
        
        // ==================== æ­Œæ‰‹ç®¡ç† ====================
        document.getElementById('addSingerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const data = {
                singer_name: document.getElementById('singerName').value.trim(),
                type: document.getElementById('singerType').value
            };
            
            const country = document.getElementById('singerCountry').value.trim();
            const birthday = document.getElementById('singerBirthday').value;
            const introduction = document.getElementById('singerIntroduction').value.trim();
            
            if (country) data.country = country;
            if (birthday) data.birthday = birthday;
            if (introduction) data.introduction = introduction;
            
            try {
                const result = await AdministratorAPI.adminAddSinger(data);
                showAlert(result.message || 'æ­Œæ‰‹æ·»åŠ æˆåŠŸï¼', 'success');
                document.getElementById('addSingerForm').reset();
            } catch (error) {
                showAlert(error.error || 'æ·»åŠ å¤±è´¥', 'error');
            }
        });
        
        // ==================== ç³»ç»Ÿæ—¥å¿— ====================
        let logsPage = 1;
        
        async function loadSystemLogs(page = 1) {
            logsPage = page;
            const container = document.getElementById('logsContent');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>åŠ è½½ä¸­...</p></div>';
            
            const filters = {
                page: page,
                page_size: 20
            };
            
            const tableFilter = document.getElementById('logTableFilter').value;
            const resultFilter = document.getElementById('logResultFilter').value;
            const keyword = document.getElementById('logKeyword').value.trim();
            
            if (tableFilter) filters.target_table = tableFilter;
            if (resultFilter) filters.result = resultFilter;
            if (keyword) filters.keyword = keyword;
            
            try {
                const result = await AdministratorAPI.getSystemLogs(filters);
                
                if (!result.data || result.data.length === 0) {
                    container.innerHTML = '<p style="color: #888; text-align: center;">æš‚æ— æ—¥å¿—è®°å½•</p>';
                } else {
                    container.innerHTML = `
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f5f5f5;">
                                    <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">ID</th>
                                    <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">æ“ä½œ</th>
                                    <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">ç›®æ ‡è¡¨</th>
                                    <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">ç›®æ ‡ID</th>
                                    <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">ç»“æœ</th>
                                    <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">æ—¶é—´</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${result.data.map(log => `
                                    <tr>
                                        <td style="padding: 10px; border-bottom: 1px solid #eee;">${log.log_id}</td>
                                        <td style="padding: 10px; border-bottom: 1px solid #eee;">${log.action}</td>
                                        <td style="padding: 10px; border-bottom: 1px solid #eee;">${log.target_table || '-'}</td>
                                        <td style="padding: 10px; border-bottom: 1px solid #eee;">${log.target_id || '-'}</td>
                                        <td style="padding: 10px; border-bottom: 1px solid #eee;">
                                            <span style="color: ${log.result === 'success' ? 'green' : 'red'}">${log.result}</span>
                                        </td>
                                        <td style="padding: 10px; border-bottom: 1px solid #eee;">${log.action_time}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
                
                // åˆ†é¡µ
                const pagination = result.pagination;
                document.getElementById('logsPagination').innerHTML = `
                    <span>ç¬¬ ${pagination.current_page} / ${pagination.total_pages} é¡µ (å…± ${pagination.total_count} æ¡)</span>
                    ${pagination.current_page > 1 ? `<button class="btn btn-small btn-secondary" onclick="loadSystemLogs(${pagination.current_page - 1})">ä¸Šä¸€é¡µ</button>` : ''}
                    ${pagination.current_page < pagination.total_pages ? `<button class="btn btn-small btn-secondary" onclick="loadSystemLogs(${pagination.current_page + 1})">ä¸‹ä¸€é¡µ</button>` : ''}
                `;
            } catch (error) {
                container.innerHTML = `<div class="alert alert-error">${error.error || 'åŠ è½½å¤±è´¥'}</div>`;
            }
        }
        
        // ==================== ç”¨æˆ·ç»Ÿè®¡ ====================
        function initStatsDateRange() {
            const today = new Date();
            const sevenDaysAgo = new Date(today);
            sevenDaysAgo.setDate(today.getDate() - 7);
            
            document.getElementById('statsStartDate').value = sevenDaysAgo.toISOString().split('T')[0];
            document.getElementById('statsEndDate').value = today.toISOString().split('T')[0];
        }
        
        async function loadUserStats() {
            const container = document.getElementById('statsContent');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>åŠ è½½ä¸­...</p></div>';
            
            const startDate = document.getElementById('statsStartDate').value;
            const endDate = document.getElementById('statsEndDate').value;
            
            try {
                const result = await AdministratorAPI.getUserBehaviorStats({
                    start_date: startDate,
                    end_date: endDate
                });
                
                const summary = result.summary || {};
                const topUsers = result.top_active_users || [];
                
                container.innerHTML = `
                    <h4 style="margin-bottom: 15px;">ğŸ“ˆ æ•°æ®æ¦‚è§ˆ</h4>
                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-bottom: 30px;">
                        <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #1976d2;">${summary.new_users || 0}</div>
                            <div style="color: #666;">æ–°å¢ç”¨æˆ·</div>
                        </div>
                        <div style="background: #e8f5e9; padding: 20px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #388e3c;">${summary.total_plays || 0}</div>
                            <div style="color: #666;">æ’­æ”¾æ¬¡æ•°</div>
                        </div>
                        <div style="background: #fff3e0; padding: 20px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #f57c00;">${summary.total_comments || 0}</div>
                            <div style="color: #666;">è¯„è®ºæ•°</div>
                        </div>
                        <div style="background: #fce4ec; padding: 20px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #c2185b;">${summary.total_favorites || 0}</div>
                            <div style="color: #666;">æ”¶è—æ•°</div>
                        </div>
                        <div style="background: #f3e5f5; padding: 20px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #7b1fa2;">${summary.new_songlists || 0}</div>
                            <div style="color: #666;">æ–°å»ºæ­Œå•</div>
                        </div>
                    </div>
                    
                    <h4 style="margin-bottom: 15px;">ğŸ† æ´»è·ƒç”¨æˆ·æ’è¡Œ (Top 10)</h4>
                    ${topUsers.length > 0 ? `
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f5f5f5;">
                                    <th style="padding: 10px; text-align: left;">æ’å</th>
                                    <th style="padding: 10px; text-align: left;">ç”¨æˆ·å</th>
                                    <th style="padding: 10px; text-align: left;">é‚®ç®±</th>
                                    <th style="padding: 10px; text-align: left;">æ’­æ”¾æ¬¡æ•°</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${topUsers.map((user, index) => `
                                    <tr>
                                        <td style="padding: 10px; border-bottom: 1px solid #eee;">${index + 1}</td>
                                        <td style="padding: 10px; border-bottom: 1px solid #eee;">${user.user_name}</td>
                                        <td style="padding: 10px; border-bottom: 1px solid #eee;">${user.email || '-'}</td>
                                        <td style="padding: 10px; border-bottom: 1px solid #eee;">${user.play_count}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    ` : '<p style="color: #888;">æš‚æ— æ•°æ®</p>'}
                `;
            } catch (error) {
                container.innerHTML = `<div class="alert alert-error">${error.error || 'åŠ è½½å¤±è´¥'}</div>`;
            }
        }
        
        // ==================== è¯„è®ºå®¡æ ¸ ====================
        let commentsPage = 1;
        
        async function loadPendingComments(page = 1) {
            commentsPage = page;
            const container = document.getElementById('pendingComments');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>åŠ è½½ä¸­...</p></div>';
            
            try {
                const result = await AdministratorAPI.getPendingComments(page, 20);
                
                if (!result.pending_comments || result.pending_comments.length === 0) {
                    container.innerHTML = '<p style="color: #888; text-align: center;">æš‚æ— å¾…å®¡æ ¸è¯„è®º ğŸ‰</p>';
                } else {
                    container.innerHTML = result.pending_comments.map(comment => `
                        <div class="comment-item" style="padding: 15px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <div>
                                    <strong>${comment.user_name}</strong>
                                    <span style="background: ${comment.status === 'ä¸¾æŠ¥ä¸­' ? '#ffebee' : '#fff3e0'}; color: ${comment.status === 'ä¸¾æŠ¥ä¸­' ? '#c62828' : '#ef6c00'}; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin-left: 10px;">${comment.status}</span>
                                </div>
                                <span style="color: #888; font-size: 12px;">${comment.comment_time}</span>
                            </div>
                            <div style="margin-bottom: 10px; padding: 10px; background: #f5f5f5; border-radius: 4px;">${comment.content}</div>
                            <div style="color: #888; font-size: 12px; margin-bottom: 10px;">
                                ç›®æ ‡: ${comment.target_type} #${comment.target_id} | ç”¨æˆ·ID: ${comment.user_id} | ç”¨æˆ·çŠ¶æ€: ${comment.user_status}
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-small btn-primary" onclick="auditComment(${comment.comment_id}, 'pass')">âœ“ é€šè¿‡</button>
                                <button class="btn btn-small btn-danger" onclick="auditComment(${comment.comment_id}, 'reject', false)">âœ— åˆ é™¤è¯„è®º</button>
                                <button class="btn btn-small btn-danger" onclick="auditComment(${comment.comment_id}, 'reject', true)">ğŸš« åˆ é™¤å¹¶å°ç¦ç”¨æˆ·</button>
                            </div>
                        </div>
                    `).join('');
                }
                
                // åˆ†é¡µ
                const total = result.total || 0;
                const totalPages = Math.ceil(total / 20);
                document.getElementById('commentsPagination').innerHTML = `
                    <span>ç¬¬ ${page} / ${totalPages || 1} é¡µ (å…± ${total} æ¡)</span>
                    ${page > 1 ? `<button class="btn btn-small btn-secondary" onclick="loadPendingComments(${page - 1})">ä¸Šä¸€é¡µ</button>` : ''}
                    ${page < totalPages ? `<button class="btn btn-small btn-secondary" onclick="loadPendingComments(${page + 1})">ä¸‹ä¸€é¡µ</button>` : ''}
                `;
            } catch (error) {
                container.innerHTML = `<div class="alert alert-error">${error.error || 'åŠ è½½å¤±è´¥'}</div>`;
            }
        }
        
        async function auditComment(commentId, result, banUser = false) {
            const actionText = result === 'pass' ? 'é€šè¿‡' : (banUser ? 'åˆ é™¤å¹¶å°ç¦ç”¨æˆ·' : 'åˆ é™¤');
            if (!confirm(`ç¡®å®šè¦${actionText}æ­¤è¯„è®ºå—ï¼Ÿ`)) return;
            
            try {
                await AdministratorAPI.auditComment(commentId, result, banUser);
                showAlert(`è¯„è®ºå·²${actionText}`, 'success');
                loadPendingComments(commentsPage);
            } catch (error) {
                showAlert(error.error || 'æ“ä½œå¤±è´¥', 'error');
            }
        }
        
        function showAlert(message, type) {
            const alertBox = document.getElementById('alertBox');
            alertBox.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => alertBox.innerHTML = '', 3000);
        }
    </script>
</body>
</html>
