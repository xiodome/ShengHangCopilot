<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å£°èˆªéŸ³ä¹ - é¦–é¡µ</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <a href="index.html" class="logo">ğŸµ å£°èˆªéŸ³ä¹</a>
        <div class="nav-links">
            <a href="index.html">é¦–é¡µ</a>
            <a href="music.html">éŸ³ä¹ä¸­å¿ƒ</a>
            <a href="songlist.html">æˆ‘çš„æ­Œå•</a>
            <a href="favorites.html">æˆ‘çš„æ”¶è—</a>
            <a href="history.html">æ’­æ”¾è®°å½•</a>
            <a href="profile.html">ä¸ªäººä¸­å¿ƒ</a>
            <span id="adminLink" style="display: none;"><a href="admin.html">ç®¡ç†åå°</a></span>
        </div>
        <div class="user-info">
            <span id="welcomeText">åŠ è½½ä¸­...</span>
            <button class="logout-btn" onclick="handleLogout()">é€€å‡ºç™»å½•</button>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹ -->
    <div class="container">
        <div id="alertBox"></div>
        
        <!-- æ¬¢è¿åŒºåŸŸ -->
        <div class="card">
            <h2 style="margin-bottom: 15px;">ğŸ‘‹ æ¬¢è¿æ¥åˆ°å£°èˆªéŸ³ä¹</h2>
            <p style="color: #666;">å‘ç°å¥½éŸ³ä¹ï¼Œåˆ†äº«å¥½å¿ƒæƒ…ã€‚åœ¨è¿™é‡Œï¼Œæ‚¨å¯ä»¥æœç´¢æ­Œæ›²ã€åˆ›å»ºæ­Œå•ã€æ”¶è—å–œçˆ±çš„éŸ³ä¹ã€‚</p>
        </div>
        
        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 20px;">
            <div class="stat-card home-stat-card">
                <div class="number" id="playCountWeek">-</div>
                <div class="label">æœ¬å‘¨æ’­æ”¾</div>
            </div>
            <div class="stat-card home-stat-card">
                <div class="number" id="favoriteCount">-</div>
                <div class="label">æ”¶è—æ­Œæ›²</div>
            </div>
            <div class="stat-card home-stat-card">
                <div class="number" id="songlistCount">-</div>
                <div class="label">æˆ‘çš„æ­Œå•</div>
            </div>
            <div class="stat-card home-stat-card">
                <div class="number" id="followingCount">-</div>
                <div class="label">å…³æ³¨æ•°</div>
            </div>
        </div>
        
        <!-- å¿«é€Ÿæœç´¢ -->
        <div class="card">
            <h3 class="card-title">ğŸ” å¿«é€Ÿæœç´¢</h3>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="æœç´¢æ­Œæ›²ã€æ­Œæ‰‹ã€ä¸“è¾‘...">
                <select id="searchType" style="padding: 12px; border-radius: 25px; border: 1px solid #ddd;">
                    <option value="song">æ­Œæ›²</option>
                    <option value="singer">æ­Œæ‰‹</option>
                    <option value="album">ä¸“è¾‘</option>
                    <option value="songlist">æ­Œå•</option>
                </select>
                <button onclick="performSearch()">æœç´¢</button>
            </div>
            <div id="searchResults"></div>
        </div>
        
        <!-- æ’­æ”¾æŠ¥å‘Š -->
        <div class="card">
            <h3 class="card-title">ğŸ“Š æœ¬å‘¨å¬æ­ŒæŠ¥å‘Š</h3>
            <div id="weekReport" class="loading">
                <div class="spinner"></div>
                <p>åŠ è½½ä¸­...</p>
            </div>
        </div>
        
        <!-- æœ€çˆ±æ­Œæ›² -->
        <div class="card">
            <h3 class="card-title">â¤ï¸ æˆ‘æœ€å¸¸å¬çš„æ­Œæ›²</h3>
            <div id="topSongs" class="loading">
                <div class="spinner"></div>
                <p>åŠ è½½ä¸­...</p>
            </div>
        </div>
        
        <!-- å¹³å°çƒ­é—¨æ”¶è— -->
        <div class="card">
            <h3 class="card-title">ğŸ”¥ å¹³å°çƒ­é—¨æ”¶è—</h3>
            <div id="topFavorites" class="loading">
                <div class="spinner"></div>
                <p>åŠ è½½ä¸­...</p>
            </div>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        if (!UserStore.isLoggedIn()) {
            window.location.href = 'login.html';
        }
        
        // é¡µé¢åŠ è½½
        document.addEventListener('DOMContentLoaded', function() {
            initPage();
        });
        
        async function initPage() {
            // æ›´æ–°æ¬¢è¿æ–‡å­—
            document.getElementById('welcomeText').textContent = 'æ¬¢è¿ï¼Œ' + UserStore.getUsername();
            
            // æ˜¾ç¤ºç®¡ç†å‘˜é“¾æ¥
            if (UserStore.isAdmin()) {
                document.getElementById('adminLink').style.display = 'inline';
            }
            
            // åŠ è½½æ•°æ®
            loadStats();
            loadWeekReport();
            loadTopSongs();
            loadTopFavorites();
        }
        
        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStats() {
            try {
                // æ’­æ”¾æŠ¥å‘Š
                const report = await PlayHistoryAPI.getPlayReport('week');
                document.getElementById('playCountWeek').textContent = report.report.total_plays || 0;
                
                // æ”¶è—
                const favorites = await FavoriteAPI.listFavorites();
                document.getElementById('favoriteCount').textContent = favorites.songs?.count || 0;
                
                // æ­Œå•
                const songlists = await SonglistAPI.listSonglists();
                document.getElementById('songlistCount').textContent = songlists.total || 0;
                
                // å…³æ³¨
                const userId = UserStore.getUserId();
                const followings = await UserAPI.getFollowings(userId);
                document.getElementById('followingCount').textContent = followings.total_count || 0;
                
            } catch (error) {
                console.log('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½æœ¬å‘¨æŠ¥å‘Š
        async function loadWeekReport() {
            try {
                const report = await PlayHistoryAPI.getPlayReport('week');
                const container = document.getElementById('weekReport');
                
                if (report.report.total_plays === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">ğŸ§</div>
                            <p>æœ¬å‘¨è¿˜æ²¡æœ‰æ’­æ”¾è®°å½•ï¼Œå¿«å»å¬å¬éŸ³ä¹å§ï¼</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div style="display: flex; gap: 30px; flex-wrap: wrap;">
                            <div>
                                <p style="font-size: 14px; color: #888;">æ’­æ”¾æ¬¡æ•°</p>
                                <p style="font-size: 28px; font-weight: bold; color: #667eea;">${report.report.total_plays}</p>
                            </div>
                            <div>
                                <p style="font-size: 14px; color: #888;">æ€»æ—¶é•¿</p>
                                <p style="font-size: 28px; font-weight: bold; color: #667eea;">${report.report.total_duration_minutes} åˆ†é’Ÿ</p>
                            </div>
                            ${report.report.top_song ? `
                            <div>
                                <p style="font-size: 14px; color: #888;">æœ€çˆ±æ­Œæ›²</p>
                                <p style="font-size: 18px; font-weight: bold; color: #333;">ğŸµ ${report.report.top_song.song_title}</p>
                                <p style="font-size: 12px; color: #888;">æ’­æ”¾ ${report.report.top_song.play_times} æ¬¡</p>
                            </div>
                            ` : ''}
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('weekReport').innerHTML = `
                    <div class="empty-state">
                        <p>æš‚æ— æ’­æ”¾æ•°æ®</p>
                    </div>
                `;
            }
        }
        
        // åŠ è½½æœ€çˆ±æ­Œæ›²
        async function loadTopSongs() {
            try {
                const result = await PlayHistoryAPI.getUserTopCharts('song', 5);
                const container = document.getElementById('topSongs');
                
                if (!result.list || result.list.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">ğŸµ</div>
                            <p>è¿˜æ²¡æœ‰æ’­æ”¾è®°å½•</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = result.list.map((song, index) => `
                        <div class="song-item">
                            <div style="width: 30px; text-align: center; font-weight: bold; color: ${index < 3 ? '#667eea' : '#888'};">
                                ${index + 1}
                            </div>
                            <div class="song-info">
                                <div class="song-title">${song.song_title}</div>
                                <div class="song-meta">æ’­æ”¾ ${song.my_play_count} æ¬¡</div>
                            </div>
                            <div class="song-actions">
                                <button class="btn btn-small btn-secondary" onclick="viewSong(${song.song_id})">æŸ¥çœ‹</button>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                document.getElementById('topSongs').innerHTML = `
                    <div class="empty-state">
                        <p>åŠ è½½å¤±è´¥</p>
                    </div>
                `;
            }
        }
        
        // åŠ è½½å¹³å°çƒ­é—¨æ”¶è—
        async function loadTopFavorites() {
            try {
                const container = document.getElementById('topFavorites');
                container.innerHTML = '<div class="loading">åŠ è½½çƒ­é—¨æ”¶è—ä¸­...</div>';
                
                // å®šä¹‰ä¸‰ç§æ”¶è—ç±»å‹
                const favoriteTypes = ['song', 'album', 'songlist'];
                const typeLabels = {
                    'song': 'çƒ­é—¨æ­Œæ›²',
                    'album': 'çƒ­é—¨ä¸“è¾‘',
                    'songlist': 'çƒ­é—¨æ­Œå•'
                };
                
                let allResults = {};
                
                // ä¸ºæ¯ç§ç±»å‹å‘èµ·è¯·æ±‚
                for (const type of favoriteTypes) {
                    try {
                        const result = await DataCache.cachedRequest(
                            `platformTopFavorites_${type}`,
                            () => FavoriteAPI.getPlatformTopFavorites(type, 5), // æ¯ç§ç±»å‹è·å–5ä¸ª
                            `topFavorites_${type}`,
                            `åŠ è½½${typeLabels[type]}ä¸­...`,
                            `åŠ è½½${typeLabels[type]}å¤±è´¥`
                        );
                        
                        // åç«¯è¿”å›çš„æ•°æ®ç»“æ„æ˜¯ { ranking: [...], type: "song/album/songlist" }
                        // æˆ‘ä»¬éœ€è¦å°†å…¶è½¬æ¢ä¸ºå‰ç«¯æœŸæœ›çš„æ ¼å¼
                        allResults[type] = result.ranking || [];
                    } catch (error) {
                        console.error(`åŠ è½½${typeLabels[type]}å¤±è´¥:`, error);
                        allResults[type] = [];
                    }
                }
                
                // æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•æ•°æ®
                const hasAnyData = Object.values(allResults).some(items => items.length > 0);
                
                if (!hasAnyData) {
                    showEmpty('topFavorites', 'æš‚æ— çƒ­é—¨æ”¶è—æ•°æ®');
                    return;
                }
                
                // æ„å»ºHTMLå†…å®¹
                let htmlContent = '';
                
                // ä¸ºæ¯ç§ç±»å‹åˆ›å»ºä¸€ä¸ªåŒºåŸŸ
                for (const type of favoriteTypes) {
                    const items = allResults[type];
                    if (items.length === 0) continue;
                    
                    htmlContent += `
                        <div class="favorites-section">
                            <h3 class="section-title">${typeLabels[type]}</h3>
                            <div class="favorites-list">
                                ${items.map((item, index) => {
                                    // æ ¹æ®æ”¶è—ç±»å‹æ˜¾ç¤ºä¸åŒçš„å›¾æ ‡å’Œä¿¡æ¯
                                    let icon, title, subtitle, actionButton;
                                    
                                    if (type === 'song') {
                                        icon = 'ğŸµ';
                                        title = item.name || 'æœªçŸ¥æ­Œæ›²';
                                        subtitle = `æ”¶è— ${item.fav_count} æ¬¡`;
                                        actionButton = `<button class="btn btn-small btn-primary" onclick="viewSong(${item.target_id})">æŸ¥çœ‹</button>`;
                                    } else if (type === 'album') {
                                        icon = 'ğŸ’¿';
                                        title = item.name || 'æœªçŸ¥ä¸“è¾‘';
                                        subtitle = `æ”¶è— ${item.fav_count} æ¬¡`;
                                        actionButton = `<button class="btn btn-small btn-primary" onclick="viewAlbum(${item.target_id})">æŸ¥çœ‹</button>`;
                                    } else if (type === 'songlist') {
                                        icon = 'ï¿½';
                                        title = item.name || 'æœªçŸ¥æ­Œå•';
                                        subtitle = `æ”¶è— ${item.fav_count} æ¬¡`;
                                        actionButton = `<button class="btn btn-small btn-primary" onclick="viewSonglist(${item.target_id})">æŸ¥çœ‹</button>`;
                                    } else {
                                        icon = 'ğŸ“‹';
                                        title = item.name || 'æœªçŸ¥é¡¹ç›®';
                                        subtitle = `æ”¶è— ${item.fav_count} æ¬¡`;
                                        actionButton = '';
                                    }
                                    
                                    return `
                                        <div class="song-item">
                                            <div style="width: 30px; text-align: center; font-size: 20px;">
                                                ${index < 3 ? 'ğŸ”¥' : icon}
                                            </div>
                                            <div class="song-info">
                                                <div class="song-title">${title}</div>
                                                <div class="song-meta">${subtitle}</div>
                                            </div>
                                            <div class="song-actions">
                                                ${actionButton}
                                                <button class="btn btn-small btn-secondary" onclick="addToFavorite('${type}', ${item.target_id})">æ”¶è—</button>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }
                
                container.innerHTML = htmlContent;
                
                // æ·»åŠ æ ·å¼ä»¥ç¾åŒ–ä¸åŒç±»å‹çš„åŒºåŸŸ
                if (!document.getElementById('favorites-section-styles')) {
                    const style = document.createElement('style');
                    style.id = 'favorites-section-styles';
                    style.textContent = `
                        .favorites-section {
                            margin-bottom: 20px;
                        }
                        .section-title {
                            font-size: 18px;
                            font-weight: bold;
                            margin-bottom: 10px;
                            color: #333;
                            border-left: 4px solid #667eea;
                            padding-left: 10px;
                        }
                        .favorites-list {
                            background: #f9f9f9;
                            border-radius: 8px;
                            padding: 10px;
                        }
                    `;
                    document.head.appendChild(style);
                }
                
            } catch (error) {
                // é”™è¯¯å·²åœ¨safeApiRequestä¸­å¤„ç†
                console.error('åŠ è½½å¹³å°çƒ­é—¨æ”¶è—å¤±è´¥:', error);
                console.error('é”™è¯¯è¯¦æƒ…:', JSON.stringify(error, null, 2));
                
                // æ˜¾ç¤ºæ›´å‹å¥½çš„é”™è¯¯ä¿¡æ¯
                const container = document.getElementById('topFavorites');
                if (container) {
                    let errorMsg = 'åŠ è½½çƒ­é—¨æ”¶è—å¤±è´¥';
                    if (error.error) {
                        errorMsg = error.error;
                    } else if (error.message) {
                        errorMsg = error.message;
                    }
                    
                    // å¦‚æœæœ‰åŸå§‹å“åº”ï¼Œå°è¯•æå–æœ‰ç”¨çš„ä¿¡æ¯
                    if (error.rawResponse && error.rawResponse.includes('<')) {
                        errorMsg = 'æœåŠ¡å™¨è¿”å›äº†é”™è¯¯é¡µé¢ï¼Œè¯·æ£€æŸ¥APIç«¯ç‚¹æ˜¯å¦æ­£ç¡®';
                    }
                    
                    container.innerHTML = `<div class="alert alert-error">${errorMsg}</div>`;
                }
            }
        }
        
        // æœç´¢åŠŸèƒ½
        async function performSearch() {
            const query = document.getElementById('searchInput').value.trim();
            const type = document.getElementById('searchType').value;
            
            if (!query) {
                showAlert('è¯·è¾“å…¥æœç´¢å…³é”®è¯', 'error');
                return;
            }
            
            const container = document.getElementById('searchResults');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>æœç´¢ä¸­...</p></div>';
            
            try {
                let result;
                switch (type) {
                    case 'song':
                        result = await MusicAPI.searchSong({ song_title: query });
                        displaySongResults(result.songs || []);
                        break;
                    case 'singer':
                        result = await MusicAPI.searchSinger({ singer_name: query });
                        displaySingerResults(result.singers || []);
                        break;
                    case 'album':
                        result = await MusicAPI.searchAlbum({ album_title: query });
                        displayAlbumResults(result.albums || []);
                        break;
                    case 'songlist':
                        result = await SonglistAPI.searchSonglist(query);
                        displaySonglistResults(result.songlists || []);
                        break;
                }
            } catch (error) {
                container.innerHTML = `<div class="alert alert-error">æœç´¢å¤±è´¥: ${error.error || 'è¯·ç¨åé‡è¯•'}</div>`;
            }
        }
        
        function displaySongResults(songs) {
            const container = document.getElementById('searchResults');
            if (songs.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">æœªæ‰¾åˆ°ç›¸å…³æ­Œæ›²</p>';
                return;
            }
            
            container.innerHTML = `
                <p style="margin-bottom: 15px; color: #666;">æ‰¾åˆ° ${songs.length} é¦–æ­Œæ›²</p>
                ${songs.map(song => `
                    <div class="song-item">
                        <div class="song-info">
                            <div class="song-title">${song.song_title}</div>
                            <div class="song-meta">
                                ${song.singers ? song.singers.map(s => s.singer_name).join(', ') : ''} Â· 
                                ${song.album_title} Â· ${song.duration_formatted}
                            </div>
                        </div>
                        <div class="song-actions">
                            <button class="btn btn-small btn-primary" onclick="viewSong(${song.song_id})">æŸ¥çœ‹</button>
                            <button class="btn btn-small btn-secondary" onclick="addToFavorite('song', ${song.song_id})">æ”¶è—</button>
                        </div>
                    </div>
                `).join('')}
            `;
        }
        
        function displaySingerResults(singers) {
            const container = document.getElementById('searchResults');
            if (singers.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">æœªæ‰¾åˆ°ç›¸å…³æ­Œæ‰‹</p>';
                return;
            }
            
            container.innerHTML = `
                <p style="margin-bottom: 15px; color: #666;">æ‰¾åˆ° ${singers.length} ä½æ­Œæ‰‹</p>
                ${singers.map(singer => `
                    <div class="song-item">
                        <div class="song-info">
                            <div class="song-title">${singer.singer_name}</div>
                            <div class="song-meta">${singer.type} Â· ${singer.country || 'æœªçŸ¥'}</div>
                        </div>
                        <div class="song-actions">
                            <button class="btn btn-small btn-primary" onclick="viewSinger(${singer.singer_id})">æŸ¥çœ‹</button>
                            <button class="btn btn-small btn-secondary" onclick="followSinger(${singer.singer_id})">å…³æ³¨</button>
                        </div>
                    </div>
                `).join('')}
            `;
        }
        
        function displayAlbumResults(albums) {
            const container = document.getElementById('searchResults');
            if (albums.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">æœªæ‰¾åˆ°ç›¸å…³ä¸“è¾‘</p>';
                return;
            }
            
            container.innerHTML = `
                <p style="margin-bottom: 15px; color: #666;">æ‰¾åˆ° ${albums.length} å¼ ä¸“è¾‘</p>
                ${albums.map(album => `
                    <div class="song-item">
                        <div class="song-info">
                            <div class="song-title">${album.album_title}</div>
                            <div class="song-meta">${album.singer_name} Â· ${album.release_date || 'æœªçŸ¥'}</div>
                        </div>
                        <div class="song-actions">
                            <button class="btn btn-small btn-primary" onclick="viewAlbum(${album.album_id})">æŸ¥çœ‹</button>
                            <button class="btn btn-small btn-secondary" onclick="addToFavorite('album', ${album.album_id})">æ”¶è—</button>
                        </div>
                    </div>
                `).join('')}
            `;
        }
        
        function displaySonglistResults(songlists) {
            const container = document.getElementById('searchResults');
            if (songlists.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">æœªæ‰¾åˆ°ç›¸å…³æ­Œå•</p>';
                return;
            }
            
            container.innerHTML = `
                <p style="margin-bottom: 15px; color: #666;">æ‰¾åˆ° ${songlists.length} ä¸ªæ­Œå•</p>
                ${songlists.map(list => `
                    <div class="songlist-card">
                        <div class="cover">ğŸµ</div>
                        <div class="info">
                            <div class="title">${list.songlist_title}</div>
                            <div class="desc">åˆ›å»ºè€…: ${list.user_name}</div>
                        </div>
                        <div>
                            <button class="btn btn-small btn-primary" onclick="viewSonglist(${list.songlist_id})">æŸ¥çœ‹</button>
                        </div>
                    </div>
                `).join('')}
            `;
        }
        
        // æ“ä½œå‡½æ•°
        function viewSong(songId) {
            window.location.href = `music.html?type=song&id=${songId}`;
        }
        
        function viewSinger(singerId) {
            window.location.href = `music.html?type=singer&id=${singerId}`;
        }
        
        function viewAlbum(albumId) {
            window.location.href = `music.html?type=album&id=${albumId}`;
        }
        
        function viewSonglist(songlistId) {
            window.location.href = `songlist.html?id=${songlistId}`;
        }
        
        async function addToFavorite(type, id) {
            try {
                await FavoriteAPI.addFavorite(type, id);
                showAlert('æ”¶è—æˆåŠŸï¼', 'success');
            } catch (error) {
                showAlert(error.error || 'æ”¶è—å¤±è´¥', 'error');
            }
        }
        
        async function followSinger(singerId) {
            try {
                await UserAPI.followSinger(singerId);
                showAlert('å…³æ³¨æˆåŠŸï¼', 'success');
            } catch (error) {
                showAlert(error.error || 'å…³æ³¨å¤±è´¥', 'error');
            }
        }
        
        function showAlert(message, type) {
            const alertBox = document.getElementById('alertBox');
            alertBox.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => alertBox.innerHTML = '', 3000);
        }
        
        // å›è½¦æœç´¢
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
    </script>
</body>
</html>
