<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³ä¹ä¸­å¿ƒ - å£°èˆªéŸ³ä¹</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <a href="index.html" class="logo">ğŸµ å£°èˆªéŸ³ä¹</a>
        <div class="nav-links">
            <a href="index.html">é¦–é¡µ</a>
            <a href="music.html" class="active">éŸ³ä¹ä¸­å¿ƒ</a>
            <a href="songlist.html">æˆ‘çš„æ­Œå•</a>
            <a href="favorites.html">æˆ‘çš„æ”¶è—</a>
            <a href="history.html">æ’­æ”¾è®°å½•</a>
            <a href="profile.html">ä¸ªäººä¸­å¿ƒ</a>
            <span id="adminLink" style="display: none;"><a href="admin.html">ç®¡ç†åå°</a></span>
        </div>
        <div class="user-info">
            <span id="welcomeText">åŠ è½½ä¸­...</span>
            <button class="logout-btn" onclick="handleLogout()">é€€å‡ºç™»å½•</button>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹ -->
    <div class="container">
        <div id="alertBox"></div>
        
        <!-- æ ‡ç­¾é¡µ -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('song')">ğŸµ æœç´¢æ­Œæ›²</button>
            <button class="tab" onclick="switchTab('singer')">ğŸ¤ æœç´¢æ­Œæ‰‹</button>
            <button class="tab" onclick="switchTab('album')">ğŸ’¿ æœç´¢ä¸“è¾‘</button>
        </div>
        
        <!-- æœç´¢åŒºåŸŸ -->
        <div class="card" id="searchPanel">
            <!-- æ­Œæ›²æœç´¢ -->
            <div id="songSearch" class="search-panel">
                <h3 class="card-title">æœç´¢æ­Œæ›²</h3>
                <div class="form-group">
                    <label>æ­Œæ›²åç§°</label>
                    <input type="text" id="songTitle" placeholder="è¾“å…¥æ­Œæ›²åç§°">
                </div>
                <div class="form-group">
                    <label>æ­Œæ‰‹åç§°</label>
                    <input type="text" id="songSinger" placeholder="è¾“å…¥æ­Œæ‰‹åç§°">
                </div>
                <div class="form-group">
                    <label>ä¸“è¾‘åç§°</label>
                    <input type="text" id="songAlbum" placeholder="è¾“å…¥ä¸“è¾‘åç§°">
                </div>
                <div class="form-group">
                    <label>æ’åºæ–¹å¼</label>
                    <select id="songOrder">
                        <option value="">é»˜è®¤</option>
                        <option value="song_title">æ­Œæ›²åç§°</option>
                        <option value="duration">æ—¶é•¿</option>
                        <option value="play_count">æ’­æ”¾æ¬¡æ•°</option>
                    </select>
                    <select id="songDirection" style="margin-left: 10px;">
                        <option value="asc">å‡åº</option>
                        <option value="desc">é™åº</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="searchSongs()">æœç´¢æ­Œæ›²</button>
            </div>
            
            <!-- æ­Œæ‰‹æœç´¢ -->
            <div id="singerSearch" class="search-panel" style="display: none;">
                <h3 class="card-title">æœç´¢æ­Œæ‰‹</h3>
                <div class="form-group">
                    <label>æ­Œæ‰‹åç§°</label>
                    <input type="text" id="singerName" placeholder="è¾“å…¥æ­Œæ‰‹åç§°">
                </div>
                <div class="form-group">
                    <label>æ­Œæ‰‹ç±»å‹</label>
                    <select id="singerType">
                        <option value="">å…¨éƒ¨</option>
                        <option value="ç”·">ç”·</option>
                        <option value="å¥³">å¥³</option>
                        <option value="ç»„åˆ">ç»„åˆ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å›½ç±</label>
                    <input type="text" id="singerCountry" placeholder="è¾“å…¥å›½ç±">
                </div>
                <div class="form-group">
                    <label>æ’åºæ–¹å¼</label>
                    <select id="singerOrder">
                        <option value="">é»˜è®¤(åç§°)</option>
                        <option value="songs">æ­Œæ›²æ•°é‡</option>
                        <option value="followers">ç²‰ä¸æ•°é‡</option>
                    </select>
                    <select id="singerDirection" style="margin-left: 10px;">
                        <option value="asc">å‡åº</option>
                        <option value="desc">é™åº</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="searchSingers()">æœç´¢æ­Œæ‰‹</button>
            </div>
            
            <!-- ä¸“è¾‘æœç´¢ -->
            <div id="albumSearch" class="search-panel" style="display: none;">
                <h3 class="card-title">æœç´¢ä¸“è¾‘</h3>
                <div class="form-group">
                    <label>ä¸“è¾‘åç§°</label>
                    <input type="text" id="albumTitle" placeholder="è¾“å…¥ä¸“è¾‘åç§°">
                </div>
                <div class="form-group">
                    <label>æ­Œæ‰‹åç§°</label>
                    <input type="text" id="albumSinger" placeholder="è¾“å…¥æ­Œæ‰‹åç§°">
                </div>
                <div class="form-group">
                    <label>æ’åºæ–¹å¼</label>
                    <select id="albumOrder">
                        <option value="">é»˜è®¤(åç§°)</option>
                        <option value="release_date">å‘è¡Œæ—¥æœŸ</option>
                        <option value="songs_count">æ­Œæ›²æ•°é‡</option>
                    </select>
                    <select id="albumDirection" style="margin-left: 10px;">
                        <option value="asc">å‡åº</option>
                        <option value="desc">é™åº</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="searchAlbums()">æœç´¢ä¸“è¾‘</button>
            </div>
        </div>
        
        <!-- æœç´¢ç»“æœ -->
        <div class="card" id="resultsCard" style="display: none;">
            <h3 class="card-title" id="resultsTitle">æœç´¢ç»“æœ</h3>
            <div id="results"></div>
        </div>
        
        <!-- è¯¦æƒ…é¢æ¿ -->
        <div class="card" id="detailPanel" style="display: none;">
            <button class="btn btn-secondary" onclick="closeDetail()" style="margin-bottom: 15px;">â† è¿”å›æœç´¢ç»“æœ</button>
            <div id="detailContent"></div>
        </div>
    </div>
    
    <!-- æ·»åŠ åˆ°æ­Œå•æ¨¡æ€æ¡† -->
    <div class="modal" id="addToSonglistModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>æ·»åŠ åˆ°æ­Œå•</h2>
                <button class="modal-close" onclick="closeModal('addToSonglistModal')">&times;</button>
            </div>
            <div id="songlistList" class="loading">
                <div class="spinner"></div>
                <p>åŠ è½½ä¸­...</p>
            </div>
        </div>
    </div>
    
    <!-- ç¼–è¾‘æ­Œæ‰‹æ¨¡æ€æ¡† -->
    <div class="modal" id="editSingerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ç¼–è¾‘æ­Œæ‰‹</h2>
                <button class="modal-close" onclick="closeAdminModal('editSingerModal')">&times;</button>
            </div>
            <form id="editSingerForm">
                <input type="hidden" id="editSingerId">
                <div class="form-group">
                    <label>æ­Œæ‰‹åç§° *</label>
                    <input type="text" id="editSingerName" required>
                </div>
                <div class="form-group">
                    <label>æ­Œæ‰‹ç±»å‹ *</label>
                    <select id="editSingerType" required>
                        <option value="ç”·">ç”·</option>
                        <option value="å¥³">å¥³</option>
                        <option value="ç»„åˆ">ç»„åˆ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å›½ç±</label>
                    <input type="text" id="editSingerCountry">
                </div>
                <div class="form-group">
                    <label>ç”Ÿæ—¥</label>
                    <input type="date" id="editSingerBirthday">
                </div>
                <div class="form-group">
                    <label>ç®€ä»‹</label>
                    <textarea id="editSingerIntro" style="height: 80px;"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">ä¿å­˜ä¿®æ”¹</button>
            </form>
        </div>
    </div>
    
    <!-- æ·»åŠ ä¸“è¾‘æ¨¡æ€æ¡† -->
    <div class="modal" id="addAlbumModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>æ·»åŠ ä¸“è¾‘</h2>
                <button class="modal-close" onclick="closeAdminModal('addAlbumModal')">&times;</button>
            </div>
            <form id="addAlbumForm">
                <input type="hidden" id="addAlbumSingerId">
                <div class="form-group">
                    <label>ä¸“è¾‘åç§° *</label>
                    <input type="text" id="addAlbumTitle" required>
                </div>
                <div class="form-group">
                    <label>å‘è¡Œæ—¥æœŸ</label>
                    <input type="date" id="addAlbumReleaseDate">
                </div>
                <div class="form-group">
                    <label>å°é¢URL</label>
                    <input type="text" id="addAlbumCoverUrl" placeholder="è¾“å…¥å°é¢å›¾ç‰‡URL">
                </div>
                <div class="form-group">
                    <label>æè¿°</label>
                    <textarea id="addAlbumDescription" style="height: 80px;"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">æ·»åŠ ä¸“è¾‘</button>
            </form>
        </div>
    </div>
    
    <!-- ç¼–è¾‘ä¸“è¾‘æ¨¡æ€æ¡† -->
    <div class="modal" id="editAlbumModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ç¼–è¾‘ä¸“è¾‘</h2>
                <button class="modal-close" onclick="closeAdminModal('editAlbumModal')">&times;</button>
            </div>
            <form id="editAlbumForm">
                <input type="hidden" id="editAlbumId">
                <div class="form-group">
                    <label>ä¸“è¾‘åç§° *</label>
                    <input type="text" id="editAlbumTitle" required>
                </div>
                <div class="form-group">
                    <label>æ­Œæ‰‹ID *</label>
                    <input type="number" id="editAlbumSingerId" required>
                </div>
                <div class="form-group">
                    <label>å‘è¡Œæ—¥æœŸ</label>
                    <input type="date" id="editAlbumReleaseDate">
                </div>
                <div class="form-group">
                    <label>å°é¢URL</label>
                    <input type="text" id="editAlbumCoverUrl">
                </div>
                <div class="form-group">
                    <label>æè¿°</label>
                    <textarea id="editAlbumDescription" style="height: 80px;"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">ä¿å­˜ä¿®æ”¹</button>
            </form>
        </div>
    </div>
    
    <!-- æ·»åŠ æ­Œæ›²æ¨¡æ€æ¡† -->
    <div class="modal" id="addSongModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>æ·»åŠ æ­Œæ›²</h2>
                <button class="modal-close" onclick="closeAdminModal('addSongModal')">&times;</button>
            </div>
            <form id="addSongForm">
                <input type="hidden" id="addSongAlbumId">
                <div class="form-group">
                    <label>æ­Œæ›²åç§° *</label>
                    <input type="text" id="addSongTitle" required>
                </div>
                <div class="form-group">
                    <label>æ­Œæ‰‹IDåˆ—è¡¨ * (å¤šä¸ªç”¨é€—å·åˆ†éš”)</label>
                    <input type="text" id="addSongSingersId" placeholder="ä¾‹å¦‚: 1,2,3" required>
                </div>
                <div class="form-group">
                    <label>æ—¶é•¿ * (æ ¼å¼: mm:ss)</label>
                    <input type="text" id="addSongDuration" placeholder="ä¾‹å¦‚: 4:30" required pattern="\d+:\d{2}">
                </div>
                <div class="form-group">
                    <label>éŸ³é¢‘æ–‡ä»¶URL *</label>
                    <input type="text" id="addSongFileUrl" placeholder="è¾“å…¥éŸ³é¢‘æ–‡ä»¶URL" required>
                </div>
                <button type="submit" class="btn btn-primary">æ·»åŠ æ­Œæ›²</button>
            </form>
        </div>
    </div>
    
    <!-- ç¼–è¾‘æ­Œæ›²æ¨¡æ€æ¡† -->
    <div class="modal" id="editSongModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ç¼–è¾‘æ­Œæ›²</h2>
                <button class="modal-close" onclick="closeAdminModal('editSongModal')">&times;</button>
            </div>
            <form id="editSongForm">
                <input type="hidden" id="editSongId">
                <div class="form-group">
                    <label>æ­Œæ›²åç§° *</label>
                    <input type="text" id="editSongTitle" required>
                </div>
                <div class="form-group">
                    <label>æ‰€å±ä¸“è¾‘ID *</label>
                    <input type="number" id="editSongAlbumId" required>
                </div>
                <div class="form-group">
                    <label>æ—¶é•¿ (æ ¼å¼: mm:ss)</label>
                    <input type="text" id="editSongDuration" pattern="\d+:\d{2}">
                </div>
                <div class="form-group">
                    <label>éŸ³é¢‘æ–‡ä»¶URL</label>
                    <input type="text" id="editSongFileUrl">
                </div>
                <button type="submit" class="btn btn-primary">ä¿å­˜ä¿®æ”¹</button>
            </form>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        if (!UserStore.isLoggedIn()) {
            window.location.href = 'login.html';
        }
        
        let currentTab = 'song';
        let selectedSongId = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('welcomeText').textContent = 'æ¬¢è¿ï¼Œ' + UserStore.getUsername();

            if (UserStore.isAdmin()) {
                const adminLink = document.getElementById('adminLink');
                if (adminLink) {
                    adminLink.style.display = 'inline';
                }
            }
            
            // æ£€æŸ¥URLå‚æ•°
            const params = new URLSearchParams(window.location.search);
            const type = params.get('type');
            const id = params.get('id');
            
            if (type && id) {
                switchTab(type);
                loadDetail(type, id);
            }
        });
        
        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tab) {
            currentTab = tab;
            
            // æ›´æ–°æ ‡ç­¾æ ·å¼
            document.querySelectorAll('.tab').forEach((t, index) => {
                t.classList.remove('active');
                if ((tab === 'song' && index === 0) ||
                    (tab === 'singer' && index === 1) ||
                    (tab === 'album' && index === 2)) {
                    t.classList.add('active');
                }
            });
            
            // æ˜¾ç¤ºå¯¹åº”æœç´¢é¢æ¿
            document.querySelectorAll('.search-panel').forEach(p => p.style.display = 'none');
            document.getElementById(tab + 'Search').style.display = 'block';
            
            // éšè—è¯¦æƒ…
            document.getElementById('detailPanel').style.display = 'none';
            document.getElementById('searchPanel').style.display = 'block';
            document.getElementById('resultsCard').style.display = 'none';
        }
        
        // æœç´¢æ­Œæ›²
        async function searchSongs() {
            const filters = {};
            const title = document.getElementById('songTitle').value.trim();
            const singer = document.getElementById('songSinger').value.trim();
            const album = document.getElementById('songAlbum').value.trim();
            const order = document.getElementById('songOrder').value;
            const direction = document.getElementById('songDirection').value;
            
            if (title) filters.song_title = title;
            if (singer) filters.singer_name = singer;
            if (album) filters.album_title = album;
            if (order) filters.order = order;
            if (direction) filters.direction = direction;
            
            showLoading('results');
            document.getElementById('resultsCard').style.display = 'block';
            document.getElementById('resultsTitle').textContent = 'æ­Œæ›²æœç´¢ç»“æœ';
            
            try {
                const result = await MusicAPI.searchSong(filters);
                displaySongs(result.songs || []);
            } catch (error) {
                showError('results', error.error || 'æœç´¢å¤±è´¥');
            }
        }
        
        // æœç´¢æ­Œæ‰‹
        async function searchSingers() {
            const filters = {};
            const name = document.getElementById('singerName').value.trim();
            const type = document.getElementById('singerType').value;
            const country = document.getElementById('singerCountry').value.trim();
            const order = document.getElementById('singerOrder').value;
            const direction = document.getElementById('singerDirection').value;
            
            if (name) filters.singer_name = name;
            if (type) filters.type = type;
            if (country) filters.country = country;
            if (order) filters.order = order;
            if (direction) filters.direction = direction;
            
            showLoading('results');
            document.getElementById('resultsCard').style.display = 'block';
            document.getElementById('resultsTitle').textContent = 'æ­Œæ‰‹æœç´¢ç»“æœ';
            
            try {
                const result = await MusicAPI.searchSinger(filters);
                displaySingers(result.singers || []);
            } catch (error) {
                showError('results', error.error || 'æœç´¢å¤±è´¥');
            }
        }
        
        // æœç´¢ä¸“è¾‘
        async function searchAlbums() {
            const filters = {};
            const title = document.getElementById('albumTitle').value.trim();
            const singer = document.getElementById('albumSinger').value.trim();
            const order = document.getElementById('albumOrder').value;
            const direction = document.getElementById('albumDirection').value;
            
            if (title) filters.album_title = title;
            if (singer) filters.singer_name = singer;
            if (order) filters.order = order;
            if (direction) filters.direction = direction;
            
            showLoading('results');
            document.getElementById('resultsCard').style.display = 'block';
            document.getElementById('resultsTitle').textContent = 'ä¸“è¾‘æœç´¢ç»“æœ';
            
            try {
                const result = await MusicAPI.searchAlbum(filters);
                displayAlbums(result.albums || []);
            } catch (error) {
                showError('results', error.error || 'æœç´¢å¤±è´¥');
            }
        }
        
        // æ˜¾ç¤ºæ­Œæ›²åˆ—è¡¨
        function displaySongs(songs) {
            const container = document.getElementById('results');
            if (songs.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">ğŸµ</div><p>æœªæ‰¾åˆ°æ­Œæ›²</p></div>';
                return;
            }
            
            container.innerHTML = songs.map(song => `
                <div class="song-item">
                    <div class="song-info" style="cursor: pointer;" onclick="viewSongDetail(${song.song_id})">
                        <div class="song-title">${song.song_title}</div>
                        <div class="song-meta">
                            ${song.singers ? song.singers.map(s => s.singer_name).join(', ') : ''} Â· 
                            ${song.album_title} Â· ${song.duration_formatted}
                        </div>
                    </div>
                    <div class="song-actions">
                        <button class="btn btn-small btn-primary" onclick="playSong(${song.song_id})">æ’­æ”¾</button>
                        <button class="btn btn-small btn-secondary" onclick="addToFavorite('song', ${song.song_id})">æ”¶è—</button>
                        <button class="btn btn-small btn-secondary" onclick="showAddToSonglist(${song.song_id})">æ·»åŠ åˆ°æ­Œå•</button>
                    </div>
                </div>
            `).join('');
        }
        
        // æ˜¾ç¤ºæ­Œæ‰‹åˆ—è¡¨
        function displaySingers(singers) {
            const container = document.getElementById('results');
            if (singers.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ¤</div><p>æœªæ‰¾åˆ°æ­Œæ‰‹</p></div>';
                return;
            }
            
            container.innerHTML = singers.map(singer => `
                <div class="song-item" style="cursor: pointer;" onclick="viewSingerDetail(${singer.singer_id})">
                    <div class="song-info">
                        <div class="song-title">${singer.singer_name}</div>
                        <div class="song-meta">${singer.type} Â· ${singer.country || 'æœªçŸ¥'}</div>
                    </div>
                    <div class="song-actions">
                        <button class="btn btn-small btn-primary" onclick="event.stopPropagation(); followSinger(${singer.singer_id})">å…³æ³¨</button>
                    </div>
                </div>
            `).join('');
        }
        
        // æ˜¾ç¤ºä¸“è¾‘åˆ—è¡¨
        function displayAlbums(albums) {
            const container = document.getElementById('results');
            if (albums.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ’¿</div><p>æœªæ‰¾åˆ°ä¸“è¾‘</p></div>';
                return;
            }
            
            container.innerHTML = albums.map(album => `
                <div class="song-item" style="cursor: pointer;" onclick="viewAlbumDetail(${album.album_id})">
                    <div class="song-info">
                        <div class="song-title">${album.album_title}</div>
                        <div class="song-meta">${album.singer_name} Â· ${album.release_date || 'æœªçŸ¥'}</div>
                    </div>
                    <div class="song-actions">
                        <button class="btn btn-small btn-secondary" onclick="event.stopPropagation(); addToFavorite('album', ${album.album_id})">æ”¶è—</button>
                    </div>
                </div>
            `).join('');
        }
        
        // æŸ¥çœ‹è¯¦æƒ…
        async function loadDetail(type, id) {
            document.getElementById('searchPanel').style.display = 'none';
            document.getElementById('resultsCard').style.display = 'none';
            document.getElementById('detailPanel').style.display = 'block';
            
            showLoading('detailContent');
            
            try {
                if (type === 'song') {
                    const song = await MusicAPI.getSongProfile(id);
                    displaySongDetail(song);
                } else if (type === 'singer') {
                    const singer = await MusicAPI.getSingerProfile(id);
                    displaySingerDetail(singer);
                } else if (type === 'album') {
                    const album = await MusicAPI.getAlbumProfile(id);
                    displayAlbumDetail(album);
                }
            } catch (error) {
                showError('detailContent', error.error || 'åŠ è½½è¯¦æƒ…å¤±è´¥');
            }
        }
        
        function viewSongDetail(id) {
            loadDetail('song', id);
        }
        
        function viewSingerDetail(id) {
            loadDetail('singer', id);
        }
        
        function viewAlbumDetail(id) {
            loadDetail('album', id);
        }
        
        // æ˜¾ç¤ºæ­Œæ›²è¯¦æƒ…
        function displaySongDetail(song) {
            const container = document.getElementById('detailContent');
            container.innerHTML = `
                <h2 style="margin-bottom: 20px;">ğŸµ ${song.song_title}</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <p><strong>æ­Œæ‰‹:</strong> ${song.singers ? song.singers.map(s => `<a href="#" onclick="viewSingerDetail(${s.singer_id})">${s.singer_name}</a>`).join(', ') : 'æœªçŸ¥'}</p>
                        <p><strong>ä¸“è¾‘:</strong> <a href="#" onclick="viewAlbumDetail(${song.album_id})">${song.album_title}</a></p>
                        <p><strong>æ—¶é•¿:</strong> ${song.duration_formatted}</p>
                    </div>
                </div>
                
                <!-- éŸ³é¢‘æ’­æ”¾å™¨ -->
                ${song.file_url ? `
                <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <audio id="audioPlayer" controls style="width: 100%;">
                        <source src="${song.file_url}" type="audio/mpeg">
                        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾
                    </audio>
                </div>
                ` : ''}
                
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="playSongWithAudio(${song.song_id}, '${escapeAttr(song.file_url || '')}')">â–¶ï¸ æ’­æ”¾</button>
                    <button class="btn btn-secondary" onclick="addToFavorite('song', ${song.song_id})">â¤ï¸ æ”¶è—</button>
                    <button class="btn btn-secondary" onclick="showAddToSonglist(${song.song_id})">â• æ·»åŠ åˆ°æ­Œå•</button>
                    ${UserStore.isAdmin() ? `
                    <button class="btn btn-secondary" onclick="showEditSongModal(${song.song_id}, '${escapeAttr(song.song_title)}', ${song.album_id}, '${song.duration_formatted}', '${escapeAttr(song.file_url || '')}')">âœï¸ ç¼–è¾‘æ­Œæ›²</button>
                    <button class="btn btn-danger" onclick="deleteSong(${song.song_id})">ğŸ—‘ï¸ åˆ é™¤æ­Œæ›²</button>
                    ` : ''}
                </div>
                
                <h3 style="margin: 20px 0 15px;">ğŸ’¬ è¯„è®º</h3>
                <div id="commentStats" style="margin-bottom: 15px;">
                    <div class="loading">
                        <div class="spinner" style="width: 20px; height: 20px; margin-bottom: 10px;"></div>
                        <p style="font-size: 14px;">åŠ è½½è¯„è®ºç»Ÿè®¡ä¸­...</p>
                    </div>
                </div>
                <div style="margin-bottom: 20px;">
                    <textarea id="commentContent" placeholder="å†™ä¸‹ä½ çš„è¯„è®º..." style="width: 100%; height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 8px;"></textarea>
                    <button class="btn btn-primary" onclick="submitComment('song', ${song.song_id})" style="margin-top: 10px;">å‘è¡¨è¯„è®º</button>
                </div>
                <div id="commentList">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>åŠ è½½è¯„è®ºä¸­...</p>
                    </div>
                </div>
            `;
            
            // åŠ è½½è¯„è®ºå’Œè¯„è®ºç»Ÿè®¡
            loadCommentStats('song', song.song_id);
            loadComments('song', song.song_id);
        }
        
        // æ˜¾ç¤ºæ­Œæ‰‹è¯¦æƒ…
        function displaySingerDetail(singer) {
            const container = document.getElementById('detailContent');
            container.innerHTML = `
                <h2 style="margin-bottom: 20px;">ğŸ¤ ${singer.singer_name}</h2>
                <div style="margin-bottom: 20px;">
                    <p><strong>ç±»å‹:</strong> ${singer.type}</p>
                    <p><strong>å›½ç±:</strong> ${singer.country || 'æœªçŸ¥'}</p>
                    <p><strong>ç”Ÿæ—¥:</strong> ${singer.birthday || 'æœªçŸ¥'}</p>
                    <p><strong>ç®€ä»‹:</strong> ${singer.introduction || 'æš‚æ— ç®€ä»‹'}</p>
                </div>
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="followSinger(${singer.singer_id})">â• å…³æ³¨æ­Œæ‰‹</button>
                    ${UserStore.isAdmin() ? `
                    <button class="btn btn-secondary" onclick="showEditSingerModal(${singer.singer_id}, '${escapeAttr(singer.singer_name)}', '${singer.type}', '${escapeAttr(singer.country || '')}', '${singer.birthday || ''}', '${escapeAttr(singer.introduction || '')}')">âœï¸ ç¼–è¾‘æ­Œæ‰‹</button>
                    <button class="btn btn-danger" onclick="deleteSinger(${singer.singer_id}, '${escapeAttr(singer.singer_name)}')">ğŸ—‘ï¸ åˆ é™¤æ­Œæ‰‹</button>
                    <button class="btn btn-secondary" onclick="showAddAlbumModal(${singer.singer_id})">â• æ·»åŠ ä¸“è¾‘</button>
                    ` : ''}
                </div>
                
                <h3 style="margin: 20px 0 15px;">ğŸ’¿ ä¸“è¾‘åˆ—è¡¨ (${singer.album_count})</h3>
                ${singer.albums && singer.albums.length > 0 ? singer.albums.map(album => `
                    <div class="song-item" onclick="viewAlbumDetail(${album.album_id})" style="cursor: pointer;">
                        <div class="song-info">
                            <div class="song-title">${album.album_title}</div>
                            <div class="song-meta">${album.release_date || 'æœªçŸ¥'}</div>
                        </div>
                    </div>
                `).join('') : '<p style="color: #888;">æš‚æ— ä¸“è¾‘</p>'}
                
                <h3 style="margin: 20px 0 15px;">ğŸµ æ­Œæ›²åˆ—è¡¨ (${singer.song_count})</h3>
                ${singer.songs && singer.songs.length > 0 ? singer.songs.map(song => `
                    <div class="song-item">
                        <div class="song-info" onclick="viewSongDetail(${song.song_id})" style="cursor: pointer;">
                            <div class="song-title">${song.song_title}</div>
                            <div class="song-meta">${song.album_title} Â· ${song.duration_formatted}</div>
                        </div>
                        <div class="song-actions">
                            <button class="btn btn-small btn-primary" onclick="event.stopPropagation(); playSong(${song.song_id})">æ’­æ”¾</button>
                        </div>
                    </div>
                `).join('') : '<p style="color: #888;">æš‚æ— æ­Œæ›²</p>'}
            `;
        }
        
        // æ˜¾ç¤ºä¸“è¾‘è¯¦æƒ…
        function displayAlbumDetail(album) {
            const container = document.getElementById('detailContent');
            container.innerHTML = `
                <h2 style="margin-bottom: 20px;">ğŸ’¿ ${album.album_title}</h2>
                ${album.cover_url ? `<img src="${album.cover_url}" alt="å°é¢" style="width: 200px; height: 200px; object-fit: cover; border-radius: 8px; margin-bottom: 20px;">` : ''}
                <div style="margin-bottom: 20px;">
                    <p><strong>æ­Œæ‰‹:</strong> <a href="#" onclick="viewSingerDetail(${album.singer_id})">${album.singer_name}</a></p>
                    <p><strong>å‘è¡Œæ—¥æœŸ:</strong> ${album.release_date || 'æœªçŸ¥'}</p>
                    <p><strong>æ­Œæ›²æ•°é‡:</strong> ${album.song_count}</p>
                    <p><strong>æ€»æ—¶é•¿:</strong> ${album.total_duration_formatted}</p>
                    <p><strong>ç®€ä»‹:</strong> ${album.description || 'æš‚æ— ç®€ä»‹'}</p>
                </div>
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-secondary" onclick="addToFavorite('album', ${album.album_id})">â¤ï¸ æ”¶è—ä¸“è¾‘</button>
                    ${UserStore.isAdmin() ? `
                    <button class="btn btn-secondary" onclick="showEditAlbumModal(${album.album_id}, '${escapeAttr(album.album_title)}', ${album.singer_id}, '${album.release_date || ''}', '${escapeAttr(album.cover_url || '')}', '${escapeAttr(album.description || '')}')">âœï¸ ç¼–è¾‘ä¸“è¾‘</button>
                    <button class="btn btn-danger" onclick="deleteAlbum(${album.album_id})">ğŸ—‘ï¸ åˆ é™¤ä¸“è¾‘</button>
                    <button class="btn btn-secondary" onclick="showAddSongModal(${album.album_id})">â• æ·»åŠ æ­Œæ›²</button>
                    ` : ''}
                </div>
                
                <h3 style="margin: 20px 0 15px;">ğŸµ æ­Œæ›²åˆ—è¡¨</h3>
                ${album.songs && album.songs.length > 0 ? album.songs.map(song => `
                    <div class="song-item">
                        <div class="song-info" onclick="viewSongDetail(${song.song_id})" style="cursor: pointer;">
                            <div class="song-title">${song.song_title}</div>
                            <div class="song-meta">
                                ${song.singers ? song.singers.map(s => s.singer_name).join(', ') : ''} Â· ${song.duration_formatted}
                            </div>
                        </div>
                        <div class="song-actions">
                            <button class="btn btn-small btn-primary" onclick="event.stopPropagation(); playSong(${song.song_id})">æ’­æ”¾</button>
                            <button class="btn btn-small btn-secondary" onclick="event.stopPropagation(); showAddToSonglist(${song.song_id})">æ·»åŠ </button>
                            ${UserStore.isAdmin() ? `<button class="btn btn-small btn-danger" onclick="event.stopPropagation(); deleteSong(${song.song_id})">åˆ é™¤</button>` : ''}
                        </div>
                    </div>
                `).join('') : '<p style="color: #888;">æš‚æ— æ­Œæ›²</p>'}
                
                <h3 style="margin: 20px 0 15px;">ğŸ’¬ è¯„è®º (${album.comment_count})</h3>
                <div style="margin-bottom: 20px;">
                    <textarea id="commentContent" placeholder="å†™ä¸‹ä½ çš„è¯„è®º..." style="width: 100%; height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 8px;"></textarea>
                    <button class="btn btn-primary" onclick="submitComment('album', ${album.album_id})" style="margin-top: 10px;">å‘è¡¨è¯„è®º</button>
                </div>
                <div id="commentList">
                    ${album.comments && album.comments.length > 0 ? album.comments.map(comment => `
                        <div class="comment-item">
                            <div class="comment-header">
                                <span class="username" style="cursor: pointer;" onclick="viewUserProfile(${comment.user_id})">${comment.user_name}</span>
                                <span class="time">${comment.comment_time}</span>
                            </div>
                            <div class="content">${comment.content}</div>
                            <div class="actions">
                                <button onclick="likeComment(${comment.comment_id})">ğŸ‘ ${comment.like_count}</button>
                                <button onclick="showReplyForm(${comment.comment_id}, 'album', ${album.album_id})">ğŸ’¬ å›å¤</button>
                                <button onclick="reportComment(${comment.comment_id})">ğŸš¨ ä¸¾æŠ¥</button>
                            </div>
                            <div id="replyForm_${comment.comment_id}" style="display: none; margin-top: 10px; padding-left: 20px;">
                                <textarea id="replyContent_${comment.comment_id}" placeholder="å›å¤è¯„è®º..." style="width: 100%; height: 60px; padding: 8px; border: 1px solid #ddd; border-radius: 6px;"></textarea>
                                <button class="btn btn-small btn-primary" onclick="submitReply(${comment.comment_id}, 'album', ${album.album_id})" style="margin-top: 5px;">å‘é€å›å¤</button>
                                <button class="btn btn-small btn-secondary" onclick="hideReplyForm(${comment.comment_id})" style="margin-top: 5px;">å–æ¶ˆ</button>
                            </div>
                        </div>
                    `).join('') : '<p style="color: #888; text-align: center;">æš‚æ— è¯„è®º</p>'}
                </div>
            `;
        }
        
        function closeDetail() {
            document.getElementById('detailPanel').style.display = 'none';
            document.getElementById('searchPanel').style.display = 'block';
            document.getElementById('resultsCard').style.display = 'block';
        }
        
        // æ’­æ”¾æ­Œæ›²
        async function playSong(songId) {
            try {
                await PlayHistoryAPI.recordPlay(songId, 0);
                showAlert('å¼€å§‹æ’­æ”¾ï¼', 'success');
            } catch (error) {
                console.log('è®°å½•æ’­æ”¾å¤±è´¥:', error);
            }
        }
        
        // æ”¶è—
        async function addToFavorite(type, id) {
            try {
                await FavoriteAPI.addFavorite(type, id);
                showAlert('æ”¶è—æˆåŠŸï¼', 'success');
            } catch (error) {
                showAlert(error.error || 'æ”¶è—å¤±è´¥', 'error');
            }
        }
        
        // å…³æ³¨æ­Œæ‰‹
        async function followSinger(singerId) {
            try {
                await UserAPI.followSinger(singerId);
                showAlert('å…³æ³¨æˆåŠŸï¼', 'success');
            } catch (error) {
                showAlert(error.error || 'å…³æ³¨å¤±è´¥', 'error');
            }
        }
        
        // æ˜¾ç¤ºæ·»åŠ åˆ°æ­Œå•æ¨¡æ€æ¡†
        async function showAddToSonglist(songId) {
            selectedSongId = songId;
            document.getElementById('addToSonglistModal').classList.add('active');
            
            const container = document.getElementById('songlistList');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>åŠ è½½ä¸­...</p></div>';
            
            try {
                const result = await SonglistAPI.listSonglists();
                if (!result.songlists || result.songlists.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <p>æ‚¨è¿˜æ²¡æœ‰åˆ›å»ºæ­Œå•</p>
                            <a href="songlist.html" class="btn btn-primary" style="margin-top: 10px;">åˆ›å»ºæ­Œå•</a>
                        </div>
                    `;
                } else {
                    container.innerHTML = result.songlists.map(list => `
                        <div class="songlist-card" onclick="addSongToSonglist(${list.songlist_id})" style="cursor: pointer;">
                            <div class="cover">ğŸµ</div>
                            <div class="info">
                                <div class="title">${list.songlist_title}</div>
                                <div class="desc">${list.description || 'æš‚æ— æè¿°'}</div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                container.innerHTML = `<div class="alert alert-error">åŠ è½½å¤±è´¥</div>`;
            }
        }
        
        async function addSongToSonglist(songlistId) {
            try {
                await SonglistAPI.addSongToSonglist(songlistId, selectedSongId);
                // å…ˆå…³é—­æ¨¡æ€æ¡†ï¼Œå†æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                closeModal('addToSonglistModal');
                showAlert('æ·»åŠ æˆåŠŸï¼', 'success');
            } catch (error) {
                showAlert(error.error || 'æ·»åŠ å¤±è´¥', 'error');
            }
        }
        
        function closeModal(modalId = 'addToSonglistModal') {
            try {
                const modal = document.getElementById(modalId);
                if (modal) {
                    // åªç§»é™¤activeç±»ï¼Œè®©CSSæ§åˆ¶æ˜¾ç¤ºçŠ¶æ€
                    modal.classList.remove('active');
                } else {
                    console.warn(`æ¨¡æ€æ¡†å…ƒç´ æœªæ‰¾åˆ°: ${modalId}`);
                }
            } catch (error) {
                console.error(`å…³é—­æ¨¡æ€æ¡†æ—¶å‡ºé”™: ${modalId}`, error);
            }
        }
        
        // æäº¤è¯„è®º
        async function submitComment(targetType, targetId) {
            const content = document.getElementById('commentContent').value.trim();
            if (!content) {
                showAlert('è¯·è¾“å…¥è¯„è®ºå†…å®¹', 'error');
                return;
            }
            
            try {
                await CommentAPI.publishComment(targetType, targetId, content);
                showAlert('è¯„è®ºå‘è¡¨æˆåŠŸï¼', 'success');
                document.getElementById('commentContent').value = '';
                // é‡æ–°åŠ è½½è¯¦æƒ…
                loadDetail(targetType, targetId);
            } catch (error) {
                showAlert(error.error || 'è¯„è®ºå‘è¡¨å¤±è´¥', 'error');
            }
        }
        
        // ç‚¹èµè¯„è®º
        async function likeComment(commentId) {
            try {
                await CommentAPI.actionComment(commentId, 'like');
                showAlert('ç‚¹èµæˆåŠŸï¼', 'success');
            } catch (error) {
                showAlert(error.error || 'ç‚¹èµå¤±è´¥', 'error');
            }
        }
        
        // æ˜¾ç¤ºå›å¤è¡¨å•
        function showReplyForm(commentId, targetType, targetId) {
            const form = document.getElementById(`replyForm_${commentId}`);
            if (form) {
                form.style.display = 'block';
            }
        }
        
        // éšè—å›å¤è¡¨å•
        function hideReplyForm(commentId) {
            const form = document.getElementById(`replyForm_${commentId}`);
            if (form) {
                form.style.display = 'none';
            }
        }
        
        // æäº¤å›å¤
        async function submitReply(parentId, targetType, targetId) {
            const content = document.getElementById(`replyContent_${parentId}`).value.trim();
            if (!content) {
                showAlert('è¯·è¾“å…¥å›å¤å†…å®¹', 'error');
                return;
            }
            
            try {
                await CommentAPI.publishComment(targetType, targetId, content, parentId);
                showAlert('å›å¤å‘è¡¨æˆåŠŸï¼', 'success');
                hideReplyForm(parentId);
                loadDetail(targetType, targetId);
            } catch (error) {
                showAlert(error.error || 'å›å¤å‘è¡¨å¤±è´¥', 'error');
            }
        }
        
        // ä¸¾æŠ¥è¯„è®º
        async function reportComment(commentId) {
            if (!confirm('ç¡®å®šè¦ä¸¾æŠ¥è¿™æ¡è¯„è®ºå—ï¼Ÿ')) {
                return;
            }
            
            try {
                await CommentAPI.reportComment(commentId);
                showAlert('ä¸¾æŠ¥æˆåŠŸï¼Œæˆ‘ä»¬å°†å°½å¿«å¤„ç†', 'success');
            } catch (error) {
                showAlert(error.error || 'ä¸¾æŠ¥å¤±è´¥', 'error');
            }
        }
        
        // æŸ¥çœ‹ç”¨æˆ·èµ„æ–™
        function viewUserProfile(userId) {
            window.location.href = `profile.html?user_id=${userId}`;
        }
        
        // ==================== ç®¡ç†å‘˜åŠŸèƒ½ ====================
        
        // å…³é—­ç®¡ç†å‘˜æ¨¡æ€æ¡†
        function closeAdminModal(modalId) {
            try {
                const modal = document.getElementById(modalId);
                if (modal) {
                    // åªç§»é™¤activeç±»ï¼Œè®©CSSæ§åˆ¶æ˜¾ç¤ºçŠ¶æ€
                    modal.classList.remove('active');
                } else {
                    console.warn(`æ¨¡æ€æ¡†å…ƒç´ æœªæ‰¾åˆ°: ${modalId}`);
                }
            } catch (error) {
                console.error(`å…³é—­æ¨¡æ€æ¡†æ—¶å‡ºé”™: ${modalId}`, error);
            }
        }
        
        // å±æ€§è½¬ä¹‰
        function escapeAttr(str) {
            if (!str) return '';
            return String(str)
                .replace(/\n/g, '\\n')
                .replace(/\\/g, '\\\\')
                .replace(/'/g, "\\'")
                .replace(/"/g, '\\"');
        }
        
        // æ˜¾ç¤ºç¼–è¾‘æ­Œæ‰‹æ¨¡æ€æ¡†
        function showEditSingerModal(id, name, type, country, birthday, intro) {
            document.getElementById('editSingerId').value = id;
            document.getElementById('editSingerName').value = name;
            document.getElementById('editSingerType').value = type;
            document.getElementById('editSingerCountry').value = country;
            document.getElementById('editSingerBirthday').value = birthday;
            document.getElementById('editSingerIntro').value = intro;
            document.getElementById('editSingerModal').classList.add('active');
        }
        
        // ç¼–è¾‘æ­Œæ‰‹è¡¨å•æäº¤
        document.getElementById('editSingerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const data = {
                singer_id: document.getElementById('editSingerId').value,
                singer_name: document.getElementById('editSingerName').value.trim(),
                type: document.getElementById('editSingerType').value
            };
            const country = document.getElementById('editSingerCountry').value.trim();
            const birthday = document.getElementById('editSingerBirthday').value;
            const intro = document.getElementById('editSingerIntro').value.trim();
            if (country) data.country = country;
            if (birthday) data.birthday = birthday;
            if (intro) data.introduction = intro;
            
            try {
                await AdministratorAPI.adminUpdateSinger(data);
                showAlert('æ­Œæ‰‹ä¿¡æ¯ä¿®æ”¹æˆåŠŸï¼', 'success');
                closeAdminModal('editSingerModal');
                loadDetail('singer', data.singer_id);
            } catch (error) {
                showAlert(error.error || 'ä¿®æ”¹å¤±è´¥', 'error');
            }
        });
        
        // åˆ é™¤æ­Œæ‰‹
        async function deleteSinger(singerId, singerName) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤æ­Œæ‰‹ "${singerName}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) return;
            try {
                await AdministratorAPI.adminDeleteSinger(singerId, singerName);
                showAlert('æ­Œæ‰‹åˆ é™¤æˆåŠŸï¼', 'success');
                closeDetail();
            } catch (error) {
                showAlert(error.error || 'åˆ é™¤å¤±è´¥', 'error');
            }
        }
        
        // æ˜¾ç¤ºæ·»åŠ ä¸“è¾‘æ¨¡æ€æ¡†
        function showAddAlbumModal(singerId) {
            document.getElementById('addAlbumSingerId').value = singerId;
            document.getElementById('addAlbumTitle').value = '';
            document.getElementById('addAlbumReleaseDate').value = '';
            document.getElementById('addAlbumCoverUrl').value = '';
            document.getElementById('addAlbumDescription').value = '';
            document.getElementById('addAlbumModal').classList.add('active');
        }
        
        // æ·»åŠ ä¸“è¾‘è¡¨å•æäº¤
        document.getElementById('addAlbumForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const singerId = document.getElementById('addAlbumSingerId').value;
            const data = {
                album_title: document.getElementById('addAlbumTitle').value.trim(),
                singer_id: parseInt(singerId)
            };
            const releaseDate = document.getElementById('addAlbumReleaseDate').value;
            const coverUrl = document.getElementById('addAlbumCoverUrl').value.trim();
            const description = document.getElementById('addAlbumDescription').value.trim();
            if (releaseDate) data.release_date = releaseDate;
            if (coverUrl) data.cover_url = coverUrl;
            if (description) data.description = description;
            
            try {
                await AdministratorAPI.adminAddAlbum(data);
                showAlert('ä¸“è¾‘æ·»åŠ æˆåŠŸï¼', 'success');
                closeAdminModal('addAlbumModal');
                loadDetail('singer', singerId);
            } catch (error) {
                showAlert(error.error || 'æ·»åŠ å¤±è´¥', 'error');
            }
        });
        
        // æ˜¾ç¤ºç¼–è¾‘ä¸“è¾‘æ¨¡æ€æ¡†
        function showEditAlbumModal(id, title, singerId, releaseDate, coverUrl, description) {
            document.getElementById('editAlbumId').value = id;
            document.getElementById('editAlbumTitle').value = title;
            document.getElementById('editAlbumSingerId').value = singerId;
            document.getElementById('editAlbumReleaseDate').value = releaseDate;
            document.getElementById('editAlbumCoverUrl').value = coverUrl;
            document.getElementById('editAlbumDescription').value = description;
            document.getElementById('editAlbumModal').classList.add('active');
        }
        
        // ç¼–è¾‘ä¸“è¾‘è¡¨å•æäº¤
        document.getElementById('editAlbumForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const albumId = document.getElementById('editAlbumId').value;
            const data = {
                album_id: albumId,
                album_title: document.getElementById('editAlbumTitle').value.trim(),
                singer_id: parseInt(document.getElementById('editAlbumSingerId').value)
            };
            const releaseDate = document.getElementById('editAlbumReleaseDate').value;
            const coverUrl = document.getElementById('editAlbumCoverUrl').value.trim();
            const description = document.getElementById('editAlbumDescription').value.trim();
            if (releaseDate) data.release_date = releaseDate;
            if (coverUrl) data.cover_url = coverUrl;
            if (description) data.description = description;
            
            try {
                await AdministratorAPI.adminUpdateAlbum(data);
                showAlert('ä¸“è¾‘ä¿¡æ¯ä¿®æ”¹æˆåŠŸï¼', 'success');
                closeAdminModal('editAlbumModal');
                loadDetail('album', albumId);
            } catch (error) {
                showAlert(error.error || 'ä¿®æ”¹å¤±è´¥', 'error');
            }
        });
        
        // åˆ é™¤ä¸“è¾‘
        async function deleteAlbum(albumId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤ä¸“è¾‘å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
            try {
                await AdministratorAPI.adminDeleteAlbum(albumId);
                showAlert('ä¸“è¾‘åˆ é™¤æˆåŠŸï¼', 'success');
                closeDetail();
            } catch (error) {
                showAlert(error.error || 'åˆ é™¤å¤±è´¥', 'error');
            }
        }
        
        // æ˜¾ç¤ºæ·»åŠ æ­Œæ›²æ¨¡æ€æ¡†
        function showAddSongModal(albumId) {
            document.getElementById('addSongAlbumId').value = albumId;
            document.getElementById('addSongTitle').value = '';
            document.getElementById('addSongSingersId').value = '';
            document.getElementById('addSongDuration').value = '';
            document.getElementById('addSongFileUrl').value = '';
            document.getElementById('addSongModal').classList.add('active');
        }
        
        // æ·»åŠ æ­Œæ›²è¡¨å•æäº¤
        document.getElementById('addSongForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const albumId = document.getElementById('addSongAlbumId').value;
            const singersIdStr = document.getElementById('addSongSingersId').value.trim();
            const singersId = singersIdStr.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n));
            
            if (singersId.length === 0) {
                showAlert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ­Œæ‰‹ID', 'error');
                return;
            }
            
            const data = {
                song_title: document.getElementById('addSongTitle').value.trim(),
                album_id: parseInt(albumId),
                singers_id: singersId,
                duration: document.getElementById('addSongDuration').value.trim(),
                file_url: document.getElementById('addSongFileUrl').value.trim()
            };
            
            try {
                await AdministratorAPI.adminAddSong(data);
                showAlert('æ­Œæ›²æ·»åŠ æˆåŠŸï¼', 'success');
                closeAdminModal('addSongModal');
                loadDetail('album', albumId);
            } catch (error) {
                showAlert(error.error || 'æ·»åŠ å¤±è´¥', 'error');
            }
        });
        
        // æ˜¾ç¤ºç¼–è¾‘æ­Œæ›²æ¨¡æ€æ¡†
        function showEditSongModal(id, title, albumId, duration, fileUrl) {
            document.getElementById('editSongId').value = id;
            document.getElementById('editSongTitle').value = title;
            document.getElementById('editSongAlbumId').value = albumId;
            document.getElementById('editSongDuration').value = duration;
            document.getElementById('editSongFileUrl').value = fileUrl;
            document.getElementById('editSongModal').classList.add('active');
        }
        
        // ç¼–è¾‘æ­Œæ›²è¡¨å•æäº¤
        document.getElementById('editSongForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const songId = document.getElementById('editSongId').value;
            const data = {
                song_id: songId,
                song_title: document.getElementById('editSongTitle').value.trim(),
                album_id: parseInt(document.getElementById('editSongAlbumId').value)
            };
            const duration = document.getElementById('editSongDuration').value.trim();
            const fileUrl = document.getElementById('editSongFileUrl').value.trim();
            if (duration) data.duration = durationToSeconds(duration); // è½¬æˆç§’
            if (fileUrl) data.file_url = fileUrl;
            
            try {
                await AdministratorAPI.adminUpdateSong(data);
                showAlert('æ­Œæ›²ä¿¡æ¯ä¿®æ”¹æˆåŠŸï¼', 'success');
                closeAdminModal('editSongModal');
                loadDetail('song', songId);
            } catch (error) {
                showAlert(error.error || 'ä¿®æ”¹å¤±è´¥', 'error');
            }
        });
        
        // åˆ é™¤æ­Œæ›²
        async function deleteSong(songId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤æ­Œæ›²å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
            try {
                await AdministratorAPI.adminDeleteSong(songId);
                showAlert('æ­Œæ›²åˆ é™¤æˆåŠŸï¼', 'success');
                closeDetail();
            } catch (error) {
                showAlert(error.error || 'åˆ é™¤å¤±è´¥', 'error');
            }
        }
        
        // å¸¦éŸ³é¢‘æ’­æ”¾çš„æ’­æ”¾åŠŸèƒ½
        async function playSongWithAudio(songId, fileUrl) {
            try {
                await PlayHistoryAPI.recordPlay(songId, 0);
                if (fileUrl) {
                    const player = document.getElementById('audioPlayer');
                    if (player) {
                        player.play();
                    }
                }
                showAlert('å¼€å§‹æ’­æ”¾ï¼', 'success');
            } catch (error) {
                console.log('è®°å½•æ’­æ”¾å¤±è´¥:', error);
            }
        }
        
        // è¾…åŠ©å‡½æ•°
        function showLoading(containerId) {
            document.getElementById(containerId).innerHTML = '<div class="loading"><div class="spinner"></div><p>åŠ è½½ä¸­...</p></div>';
        }
        
        function showError(containerId, message) {
            document.getElementById(containerId).innerHTML = `<div class="alert alert-error">${message}</div>`;
        }
        
        function showAlert(message, type) {
            const alertBox = document.getElementById('alertBox');
            alertBox.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => alertBox.innerHTML = '', 3000);
        }

        function durationToSeconds(duration) {
            const [m, s] = duration.split(':').map(Number);
            return m * 60 + s;
        }
        
        // åŠ è½½è¯„è®ºåˆ—è¡¨
        async function loadComments(targetType, targetId) {
            const container = document.getElementById('commentList');
            const cacheKey = `comments_${targetType}_${targetId}`;
            
            try {
                // ä½¿ç”¨å¸¦ç¼“å­˜çš„è¯·æ±‚
                const result = await DataCache.cachedRequest(
                    cacheKey,
                    () => CommentAPI.getCommentsByTarget(targetType, targetId),
                    'commentList',
                    'åŠ è½½è¯„è®ºä¸­...',
                    'åŠ è½½è¯„è®ºå¤±è´¥'
                );
                
                // ç¼“å­˜ç»“æœ
                DataCache.set(cacheKey, result);
                
                if (!result.comments || result.comments.length === 0) {
                    showEmpty('commentList', 'æš‚æ— è¯„è®º');
                    return;
                }
                
                container.innerHTML = result.comments.map(comment => `
                    <div class="comment-item">
                        <div class="comment-header">
                            <span class="username" style="cursor: pointer;" onclick="viewUserProfile(${comment.user_id})">${comment.user_name}</span>
                            <span class="time">${comment.comment_time}</span>
                        </div>
                        <div class="content">${comment.content}</div>
                        <div class="actions">
                            <button onclick="likeComment(${comment.comment_id})">ğŸ‘ ${comment.like_count}</button>
                            <button onclick="showReplyForm(${comment.comment_id}, '${targetType}', ${targetId})">ğŸ’¬ å›å¤</button>
                            <button onclick="viewCommentDetail(${comment.comment_id})">ğŸ“„ è¯¦æƒ…</button>
                            <button onclick="reportComment(${comment.comment_id})">ğŸš¨ ä¸¾æŠ¥</button>
                            ${comment.user_id === UserStore.getUserId() ? `<button onclick="deleteComment(${comment.comment_id})">ğŸ—‘ï¸ åˆ é™¤</button>` : ''}
                        </div>
                        <div id="replyForm_${comment.comment_id}" style="display: none; margin-top: 10px; padding-left: 20px;">
                            <textarea id="replyContent_${comment.comment_id}" placeholder="å›å¤è¯„è®º..." style="width: 100%; height: 60px; padding: 8px; border: 1px solid #ddd; border-radius: 6px;"></textarea>
                            <button class="btn btn-small btn-primary" onclick="submitReply(${comment.comment_id}, '${targetType}', ${targetId})" style="margin-top: 5px;">å‘é€å›å¤</button>
                            <button class="btn btn-small btn-secondary" onclick="hideReplyForm(${comment.comment_id})" style="margin-top: 5px;">å–æ¶ˆ</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                // é”™è¯¯å·²åœ¨safeApiRequestä¸­å¤„ç†
                console.error('åŠ è½½è¯„è®ºå¤±è´¥:', error);
            }
        }
        
        // åŠ è½½è¯„è®ºç»Ÿè®¡
        async function loadCommentStats(targetType, targetId) {
            const container = document.getElementById('commentStats');
            const cacheKey = `commentStats_${targetType}_${targetId}`;
            
            try {
                // ä½¿ç”¨å¸¦ç¼“å­˜çš„è¯·æ±‚
                const stats = await DataCache.cachedRequest(
                    cacheKey,
                    () => CommentAPI.getCommentStats(targetType, targetId),
                    'commentStats',
                    'åŠ è½½è¯„è®ºç»Ÿè®¡ä¸­...',
                    'åŠ è½½è¯„è®ºç»Ÿè®¡å¤±è´¥'
                );
                
                // ç¼“å­˜ç»“æœ
                DataCache.set(cacheKey, stats);
                
                container.innerHTML = `
                    <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <div class="stat-item">
                            <div class="stat-value">${stats.total_comments || 0}</div>
                            <div class="stat-label">æ€»è¯„è®ºæ•°</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${stats.total_likes || 0}</div>
                            <div class="stat-label">æ€»ç‚¹èµæ•°</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${stats.avg_likes_per_comment || 0}</div>
                            <div class="stat-label">å¹³å‡ç‚¹èµ</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${stats.comments_today || 0}</div>
                            <div class="stat-label">ä»Šæ—¥æ–°å¢</div>
                        </div>
                    </div>
                `;
            } catch (error) {
                // é”™è¯¯å·²åœ¨safeApiRequestä¸­å¤„ç†
                console.error('åŠ è½½è¯„è®ºç»Ÿè®¡å¤±è´¥:', error);
            }
        }
        
        // æŸ¥çœ‹è¯„è®ºè¯¦æƒ…
        async function viewCommentDetail(commentId) {
            try {
                // ä½¿ç”¨å¸¦ç¼“å­˜çš„è¯·æ±‚
                const commentDetail = await DataCache.cachedRequest(
                    `commentDetail_${commentId}`,
                    () => CommentAPI.getCommentDetail(commentId),
                    null, // ä¸æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼Œå› ä¸ºæ˜¯åœ¨æ¨¡æ€æ¡†ä¸­
                    'åŠ è½½è¯„è®ºè¯¦æƒ…å¤±è´¥'
                );
                
                // ç¼“å­˜ç»“æœ
                DataCache.set(`commentDetail_${commentId}`, commentDetail);
                
                // åˆ›å»ºæ¨¡æ€æ¡†å†…å®¹
                const modalContent = `
                    <div class="modal-header">
                        <h3>è¯„è®ºè¯¦æƒ…</h3>
                        <button class="modal-close" onclick="closeModal('commentDetailModal')">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="comment-detail">
                            <div class="comment-detail-header">
                                <div class="user-info">
                                    <span class="username">${commentDetail.user_name}</span>
                                    <span class="time">${commentDetail.comment_time}</span>
                                </div>
                                <div class="target-info">
                                    è¯„è®ºäº: ${commentDetail.target_type === 'song' ? 'æ­Œæ›²' : commentDetail.target_type === 'album' ? 'ä¸“è¾‘' : 'æ­Œå•'} - ${commentDetail.target_title || 'æœªçŸ¥'}
                                </div>
                            </div>
                            <div class="comment-detail-content">
                                ${commentDetail.content}
                            </div>
                            <div class="comment-detail-stats">
                                <div class="stat-item">
                                    <span class="stat-label">ç‚¹èµæ•°:</span>
                                    <span class="stat-value">${commentDetail.like_count || 0}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">å›å¤æ•°:</span>
                                    <span class="stat-value">${commentDetail.reply_count || 0}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">çŠ¶æ€:</span>
                                    <span class="stat-value">${commentDetail.is_deleted ? 'å·²åˆ é™¤' : 'æ­£å¸¸'}</span>
                                </div>
                            </div>
                            ${commentDetail.parent_comment ? `
                            <div class="parent-comment">
                                <h4>å›å¤çš„è¯„è®º:</h4>
                                <div class="parent-comment-content">
                                    <div class="parent-comment-header">
                                        <span class="username">${commentDetail.parent_comment.user_name}</span>
                                        <span class="time">${commentDetail.parent_comment.comment_time}</span>
                                    </div>
                                    <div class="content">${commentDetail.parent_comment.content}</div>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeModal('commentDetailModal')">å…³é—­</button>
                    </div>
                `;
                
                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                showModal('commentDetailModal', modalContent);
            } catch (error) {
                showAlert('åŠ è½½è¯„è®ºè¯¦æƒ…å¤±è´¥', 'error');
                console.error('åŠ è½½è¯„è®ºè¯¦æƒ…å¤±è´¥:', error);
            }
        }
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        function showModal(modalId, content) {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨æ¨¡æ€æ¡†
            let modal = document.getElementById(modalId);
            if (!modal) {
                modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'modal';
                document.body.appendChild(modal);
            }
            
            modal.innerHTML = content;
            // ä½¿ç”¨activeç±»æ¥æ˜¾ç¤ºæ¨¡æ€æ¡†ï¼Œè€Œä¸æ˜¯ç›´æ¥è®¾ç½®style.display
            modal.classList.add('active');
        }
    </script>
</body>
</html>
