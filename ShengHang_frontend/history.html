<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ’­æ”¾è®°å½• - å£°èˆªéŸ³ä¹</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <a href="index.html" class="logo">ğŸµ å£°èˆªéŸ³ä¹</a>
        <div class="nav-links">
            <a href="index.html">é¦–é¡µ</a>
            <a href="music.html">éŸ³ä¹ä¸­å¿ƒ</a>
            <a href="songlist.html">æˆ‘çš„æ­Œå•</a>
            <a href="favorites.html">æˆ‘çš„æ”¶è—</a>
            <a href="history.html" class="active">æ’­æ”¾è®°å½•</a>
            <a href="profile.html">ä¸ªäººä¸­å¿ƒ</a>
        </div>
        <div class="user-info">
            <span id="welcomeText">åŠ è½½ä¸­...</span>
            <button class="logout-btn" onclick="handleLogout()">é€€å‡ºç™»å½•</button>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹ -->
    <div class="container">
        <div id="alertBox"></div>
        
        <!-- æ ‡ç­¾é¡µ -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('history')">ğŸ“œ æ’­æ”¾è®°å½•</button>
            <button class="tab" onclick="switchTab('report')">ğŸ“Š å¬æ­ŒæŠ¥å‘Š</button>
            <button class="tab" onclick="switchTab('charts')">ğŸ† æˆ‘çš„æ’è¡Œæ¦œ</button>
        </div>
        
        <!-- æ’­æ”¾è®°å½•é¢æ¿ -->
        <div id="historyPanel">
            <div class="card">
                <h3 class="card-title">ğŸ“œ æœ€è¿‘æ’­æ”¾</h3>
                <div style="margin-bottom: 20px;">
                    <label>æ—¥æœŸèŒƒå›´ï¼š</label>
                    <input type="date" id="startDate" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                    <span> - </span>
                    <input type="date" id="endDate" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                    <button class="btn btn-secondary" onclick="filterHistory()" style="margin-left: 10px;">ç­›é€‰</button>
                </div>
                <div id="historyList" class="loading">
                    <div class="spinner"></div>
                    <p>åŠ è½½ä¸­...</p>
                </div>
            </div>
        </div>
        
        <!-- å¬æ­ŒæŠ¥å‘Šé¢æ¿ -->
        <div id="reportPanel" style="display: none;">
            <div class="card">
                <h3 class="card-title">ğŸ“Š å¬æ­ŒæŠ¥å‘Š</h3>
                <div style="margin-bottom: 20px;">
                    <label>æ—¶é—´èŒƒå›´ï¼š</label>
                    <select id="reportRange" onchange="loadReport()" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                        <option value="week">æœ€è¿‘7å¤©</option>
                        <option value="month">æœ€è¿‘30å¤©</option>
                        <option value="all">å…¨éƒ¨</option>
                    </select>
                </div>
                <div id="reportContent" class="loading">
                    <div class="spinner"></div>
                    <p>åŠ è½½ä¸­...</p>
                </div>
            </div>
            
            <div class="card">
                <h3 class="card-title">ğŸ“ˆ æ’­æ”¾è¶‹åŠ¿</h3>
                <div style="margin-bottom: 20px;">
                    <label>ç»Ÿè®¡å‘¨æœŸï¼š</label>
                    <select id="trendPeriod" onchange="loadTrend()" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                        <option value="day">æŒ‰å¤©</option>
                        <option value="month">æŒ‰æœˆ</option>
                    </select>
                </div>
                <div id="trendContent" class="loading">
                    <div class="spinner"></div>
                    <p>åŠ è½½ä¸­...</p>
                </div>
            </div>
        </div>
        
        <!-- æ’è¡Œæ¦œé¢æ¿ -->
        <div id="chartsPanel" style="display: none;">
            <div class="grid" style="grid-template-columns: repeat(3, 1fr);">
                <div class="card">
                    <h3 class="card-title">ğŸµ æœ€å¸¸å¬çš„æ­Œæ›²</h3>
                    <div id="topSongs" class="loading">
                        <div class="spinner"></div>
                        <p>åŠ è½½ä¸­...</p>
                    </div>
                </div>
                <div class="card">
                    <h3 class="card-title">ğŸ¤ æœ€å¸¸å¬çš„æ­Œæ‰‹</h3>
                    <div id="topSingers" class="loading">
                        <div class="spinner"></div>
                        <p>åŠ è½½ä¸­...</p>
                    </div>
                </div>
                <div class="card">
                    <h3 class="card-title">ğŸ’¿ æœ€å¸¸å¬çš„ä¸“è¾‘</h3>
                    <div id="topAlbums" class="loading">
                        <div class="spinner"></div>
                        <p>åŠ è½½ä¸­...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        if (!UserStore.isLoggedIn()) {
            window.location.href = 'login.html';
        }
        
        let currentTab = 'history';
        
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('welcomeText').textContent = 'æ¬¢è¿ï¼Œ' + UserStore.getUsername();
            loadHistory();
        });
        
        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tab) {
            currentTab = tab;
            
            // æ›´æ–°æ ‡ç­¾æ ·å¼
            document.querySelectorAll('.tab').forEach((t, index) => {
                t.classList.remove('active');
                if ((tab === 'history' && index === 0) ||
                    (tab === 'report' && index === 1) ||
                    (tab === 'charts' && index === 2)) {
                    t.classList.add('active');
                }
            });
            
            // éšè—æ‰€æœ‰é¢æ¿
            document.getElementById('historyPanel').style.display = 'none';
            document.getElementById('reportPanel').style.display = 'none';
            document.getElementById('chartsPanel').style.display = 'none';
            
            // æ˜¾ç¤ºå¯¹åº”é¢æ¿
            document.getElementById(tab + 'Panel').style.display = 'block';
            
            // åŠ è½½æ•°æ®
            switch (tab) {
                case 'history':
                    loadHistory();
                    break;
                case 'report':
                    loadReport();
                    loadTrend();
                    break;
                case 'charts':
                    loadCharts();
                    break;
            }
        }
        
        // åŠ è½½æ’­æ”¾å†å²
        async function loadHistory() {
            const container = document.getElementById('historyList');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>åŠ è½½ä¸­...</p></div>';
            
            try {
                const result = await PlayHistoryAPI.getMyPlayHistory({ limit: 50 });
                
                if (!result.history || result.history.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">ğŸ§</div>
                            <p>è¿˜æ²¡æœ‰æ’­æ”¾è®°å½•</p>
                            <a href="music.html" class="btn btn-primary" style="margin-top: 15px;">å»å¬éŸ³ä¹</a>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <p style="color: #888; margin-bottom: 15px;">å…± ${result.count} æ¡è®°å½•</p>
                        ${result.history.map(item => `
                            <div class="song-item">
                                <div class="song-info">
                                    <div class="song-title">${item.song_title}</div>
                                    <div class="song-meta">
                                        ${item.album_title} Â· 
                                        æ’­æ”¾äº ${formatDateTime(item.play_time)} Â· 
                                        æ’­æ”¾æ—¶é•¿ ${item.play_duration}ç§’
                                    </div>
                                </div>
                                <div class="song-actions">
                                    <button class="btn btn-small btn-primary" onclick="playSong(${item.song_id})">å†æ¬¡æ’­æ”¾</button>
                                    <button class="btn btn-small btn-secondary" onclick="viewSong(${item.song_id})">è¯¦æƒ…</button>
                                </div>
                            </div>
                        `).join('')}
                    `;
                }
            } catch (error) {
                container.innerHTML = `<div class="alert alert-error">${error.error || 'åŠ è½½å¤±è´¥'}</div>`;
            }
        }
        
        // ç­›é€‰å†å²
        async function filterHistory() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            const container = document.getElementById('historyList');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>åŠ è½½ä¸­...</p></div>';
            
            try {
                const filters = { limit: 100 };
                if (startDate) filters.start_date = startDate;
                if (endDate) filters.end_date = endDate;
                
                const result = await PlayHistoryAPI.getMyPlayHistory(filters);
                
                if (!result.history || result.history.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <p>è¯¥æ—¶é—´æ®µå†…æ²¡æœ‰æ’­æ”¾è®°å½•</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <p style="color: #888; margin-bottom: 15px;">å…± ${result.count} æ¡è®°å½•</p>
                        ${result.history.map(item => `
                            <div class="song-item">
                                <div class="song-info">
                                    <div class="song-title">${item.song_title}</div>
                                    <div class="song-meta">
                                        ${item.album_title} Â· 
                                        æ’­æ”¾äº ${formatDateTime(item.play_time)}
                                    </div>
                                </div>
                                <div class="song-actions">
                                    <button class="btn btn-small btn-primary" onclick="playSong(${item.song_id})">å†æ¬¡æ’­æ”¾</button>
                                </div>
                            </div>
                        `).join('')}
                    `;
                }
            } catch (error) {
                container.innerHTML = `<div class="alert alert-error">${error.error || 'åŠ è½½å¤±è´¥'}</div>`;
            }
        }
        
        // åŠ è½½å¬æ­ŒæŠ¥å‘Š
        async function loadReport() {
            const range = document.getElementById('reportRange').value;
            const container = document.getElementById('reportContent');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>åŠ è½½ä¸­...</p></div>';
            
            try {
                const result = await PlayHistoryAPI.getPlayReport(range);
                
                if (result.report.total_plays === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">ğŸ“Š</div>
                            <p>è¯¥æ—¶é—´æ®µå†…æ²¡æœ‰æ’­æ”¾æ•°æ®</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px;">
                            <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                                <div style="font-size: 32px; font-weight: bold; color: #667eea;">${result.report.total_plays}</div>
                                <div style="color: #888;">æ€»æ’­æ”¾æ¬¡æ•°</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                                <div style="font-size: 32px; font-weight: bold; color: #667eea;">${result.report.total_duration_minutes}</div>
                                <div style="color: #888;">æ€»æ—¶é•¿(åˆ†é’Ÿ)</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                                <div style="font-size: 32px; font-weight: bold; color: #667eea;">${result.report.top_song ? result.report.top_song.play_times : 0}</div>
                                <div style="color: #888;">æœ€çˆ±æ­Œæ›²æ’­æ”¾æ¬¡æ•°</div>
                            </div>
                        </div>
                        ${result.report.top_song ? `
                        <div style="padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; color: white;">
                            <p style="font-size: 14px; opacity: 0.9;">ğŸ† æ‚¨æœ€å–œæ¬¢çš„æ­Œæ›²</p>
                            <p style="font-size: 24px; font-weight: bold; margin-top: 10px;">${result.report.top_song.song_title}</p>
                            <p style="font-size: 14px; opacity: 0.9; margin-top: 5px;">æ’­æ”¾äº† ${result.report.top_song.play_times} æ¬¡</p>
                        </div>
                        ` : ''}
                    `;
                }
            } catch (error) {
                container.innerHTML = `<div class="alert alert-error">${error.error || 'åŠ è½½å¤±è´¥'}</div>`;
            }
        }
        
        // åŠ è½½æ’­æ”¾è¶‹åŠ¿
        async function loadTrend() {
            const period = document.getElementById('trendPeriod').value;
            const container = document.getElementById('trendContent');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>åŠ è½½ä¸­...</p></div>';
            
            try {
                const result = await PlayHistoryAPI.getUserActivityTrend(period);
                
                if (!result.trend || result.trend.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <p>æš‚æ— è¶‹åŠ¿æ•°æ®</p>
                        </div>
                    `;
                } else {
                    // ç®€å•çš„æ–‡å­—å›¾è¡¨
                    const maxCount = Math.max(...result.trend.map(t => t.play_count));
                    
                    container.innerHTML = `
                        <div style="overflow-x: auto;">
                            ${result.trend.map(item => {
                                const barWidth = maxCount > 0 ? (item.play_count / maxCount * 100) : 0;
                                return `
                                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                        <div style="width: 100px; font-size: 12px; color: #888;">${item.date_str}</div>
                                        <div style="flex: 1; height: 20px; background: #f0f0f0; border-radius: 10px; overflow: hidden;">
                                            <div style="width: ${barWidth}%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>
                                        </div>
                                        <div style="width: 50px; text-align: right; font-size: 14px; font-weight: bold; color: #333;">${item.play_count}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                }
            } catch (error) {
                container.innerHTML = `<div class="alert alert-error">${error.error || 'åŠ è½½å¤±è´¥'}</div>`;
            }
        }
        
        // åŠ è½½æ’è¡Œæ¦œ
        async function loadCharts() {
            loadTopSongs();
            loadTopSingers();
            loadTopAlbums();
        }
        
        async function loadTopSongs() {
            const container = document.getElementById('topSongs');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>åŠ è½½ä¸­...</p></div>';
            
            try {
                const result = await PlayHistoryAPI.getUserTopCharts('song', 10);
                
                if (!result.list || result.list.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>æš‚æ— æ•°æ®</p></div>';
                } else {
                    container.innerHTML = result.list.map((item, index) => `
                        <div class="song-item" style="padding: 10px 0;">
                            <div style="width: 30px; text-align: center; font-weight: bold; color: ${index < 3 ? '#667eea' : '#888'};">
                                ${index + 1}
                            </div>
                            <div class="song-info">
                                <div class="song-title" style="font-size: 14px;">${item.song_title}</div>
                                <div class="song-meta">${item.my_play_count} æ¬¡æ’­æ”¾</div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                container.innerHTML = `<div class="alert alert-error">åŠ è½½å¤±è´¥</div>`;
            }
        }
        
        async function loadTopSingers() {
            const container = document.getElementById('topSingers');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>åŠ è½½ä¸­...</p></div>';
            
            try {
                const result = await PlayHistoryAPI.getUserTopCharts('singer', 10);
                
                if (!result.list || result.list.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>æš‚æ— æ•°æ®</p></div>';
                } else {
                    container.innerHTML = result.list.map((item, index) => `
                        <div class="song-item" style="padding: 10px 0;">
                            <div style="width: 30px; text-align: center; font-weight: bold; color: ${index < 3 ? '#667eea' : '#888'};">
                                ${index + 1}
                            </div>
                            <div class="song-info">
                                <div class="song-title" style="font-size: 14px;">${item.singer_name}</div>
                                <div class="song-meta">${item.my_play_count} æ¬¡æ’­æ”¾</div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                container.innerHTML = `<div class="alert alert-error">åŠ è½½å¤±è´¥</div>`;
            }
        }
        
        async function loadTopAlbums() {
            const container = document.getElementById('topAlbums');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>åŠ è½½ä¸­...</p></div>';
            
            try {
                const result = await PlayHistoryAPI.getUserTopCharts('album', 10);
                
                if (!result.list || result.list.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>æš‚æ— æ•°æ®</p></div>';
                } else {
                    container.innerHTML = result.list.map((item, index) => `
                        <div class="song-item" style="padding: 10px 0;">
                            <div style="width: 30px; text-align: center; font-weight: bold; color: ${index < 3 ? '#667eea' : '#888'};">
                                ${index + 1}
                            </div>
                            <div class="song-info">
                                <div class="song-title" style="font-size: 14px;">${item.album_title}</div>
                                <div class="song-meta">${item.my_play_count} æ¬¡æ’­æ”¾</div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                container.innerHTML = `<div class="alert alert-error">åŠ è½½å¤±è´¥</div>`;
            }
        }
        
        // æ’­æ”¾æ­Œæ›²
        async function playSong(songId) {
            try {
                await PlayHistoryAPI.recordPlay(songId, 0);
                showAlert('å¼€å§‹æ’­æ”¾ï¼', 'success');
            } catch (error) {
                console.log('è®°å½•æ’­æ”¾å¤±è´¥:', error);
            }
        }
        
        function viewSong(songId) {
            window.location.href = `music.html?type=song&id=${songId}`;
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
        function formatDateTime(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleString('zh-CN');
        }
        
        function showAlert(message, type) {
            const alertBox = document.getElementById('alertBox');
            alertBox.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => alertBox.innerHTML = '', 3000);
        }
    </script>
</body>
</html>
