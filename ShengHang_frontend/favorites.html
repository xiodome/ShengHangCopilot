<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„æ”¶è— - å£°èˆªéŸ³ä¹</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <a href="index.html" class="logo">ğŸµ å£°èˆªéŸ³ä¹</a>
        <div class="nav-links">
            <a href="index.html">é¦–é¡µ</a>
            <a href="music.html">éŸ³ä¹ä¸­å¿ƒ</a>
            <a href="songlist.html">æˆ‘çš„æ­Œå•</a>
            <a href="favorites.html" class="active">æˆ‘çš„æ”¶è—</a>
            <a href="history.html">æ’­æ”¾è®°å½•</a>
            <a href="profile.html">ä¸ªäººä¸­å¿ƒ</a>
            <span id="adminLink" style="display: none;"><a href="admin.html">ç®¡ç†åå°</a></span>
        </div>
        <div class="user-info">
            <span id="welcomeText">åŠ è½½ä¸­...</span>
            <button class="logout-btn" onclick="handleLogout()">é€€å‡ºç™»å½•</button>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹ -->
    <div class="container">
        <div id="alertBox"></div>
        
        <!-- æ ‡ç­¾é¡µ -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('song')">ğŸµ æ”¶è—çš„æ­Œæ›²</button>
            <button class="tab" onclick="switchTab('album')">ğŸ’¿ æ”¶è—çš„ä¸“è¾‘</button>
            <button class="tab" onclick="switchTab('songlist')">ğŸ“‹ æ”¶è—çš„æ­Œå•</button>
        </div>
        
        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="grid" style="grid-template-columns: repeat(3, 1fr); margin-bottom: 20px;" id="statsCards">
            <div class="stat-card favorites-stat-card">
                <div class="number" id="songCount">-</div>
                <div class="label">æ”¶è—æ­Œæ›²</div>
            </div>
            <div class="stat-card favorites-stat-card">
                <div class="number" id="albumCount">-</div>
                <div class="label">æ”¶è—ä¸“è¾‘</div>
            </div>
            <div class="stat-card favorites-stat-card">
                <div class="number" id="songlistCount">-</div>
                <div class="label">æ”¶è—æ­Œå•</div>
            </div>
        </div>
        
        <!-- æ”¶è—ç»Ÿè®¡è¯¦æƒ… -->
        <div class="card" id="favoriteStatsCard" style="margin-bottom: 20px; display: none;">
            <h3 class="card-title">ğŸ“Š æ”¶è—ç»Ÿè®¡è¯¦æƒ…</h3>
            <div id="favoriteStatsContent">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>åŠ è½½ä¸­...</p>
                </div>
            </div>
        </div>
        
        <!-- æ”¶è—åˆ—è¡¨ -->
        <div class="card">
            <h3 class="card-title" id="listTitle">ğŸµ æ”¶è—çš„æ­Œæ›²</h3>
            <div id="favoriteList" class="loading">
                <div class="spinner"></div>
                <p>åŠ è½½ä¸­...</p>
            </div>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        if (!UserStore.isLoggedIn()) {
            window.location.href = 'login.html';
        }
        
        let currentTab = 'song';
        let favoritesData = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('welcomeText').textContent = 'æ¬¢è¿ï¼Œ' + UserStore.getUsername();

            if (UserStore.isAdmin()) {
                const adminLink = document.getElementById('adminLink');
                if (adminLink) {
                    adminLink.style.display = 'inline';
                }
            }

            loadFavorites();
        });
        
        // åŠ è½½æ”¶è—æ•°æ®
        async function loadFavorites() {
            try {
                favoritesData = await FavoriteAPI.listFavorites();
                
                // æ›´æ–°ç»Ÿè®¡
                document.getElementById('songCount').textContent = favoritesData.songs?.count || 0;
                document.getElementById('albumCount').textContent = favoritesData.albums?.count || 0;
                document.getElementById('songlistCount').textContent = favoritesData.songlists?.count || 0;
                
                // åŠ è½½æ”¶è—ç»Ÿè®¡æ•°æ®
                loadFavoriteStats();
                
                // æ˜¾ç¤ºå½“å‰æ ‡ç­¾é¡µå†…å®¹
                displayCurrentTab();
                
            } catch (error) {
                document.getElementById('favoriteList').innerHTML = `
                    <div class="alert alert-error">${error.error || 'åŠ è½½å¤±è´¥'}</div>
                `;
            }
        }
        
        // åŠ è½½æ”¶è—ç»Ÿè®¡æ•°æ®
        async function loadFavoriteStats() {
            const statsCard = document.getElementById('favoriteStatsCard');
            const statsContent = document.getElementById('favoriteStatsContent');
            
            // åªæœ‰æ”¶è—æ­Œæ›²æ•°é‡å¤§äº0æ—¶æ‰æ˜¾ç¤ºç»Ÿè®¡å¡ç‰‡
            const songCount = favoritesData.songs?.count || 0;
            if (songCount === 0) {
                statsCard.style.display = 'none';
                return;
            }
            
            statsCard.style.display = 'block';
            
            try {
                // ä½¿ç”¨å¸¦ç¼“å­˜çš„è¯·æ±‚
                const stats = await DataCache.cachedRequest(
                    'favoriteStats',
                    () => FavoriteAPI.getMyFavoriteSongsStats(),
                    'favoriteStatsContent',
                    'åŠ è½½ç»Ÿè®¡æ•°æ®ä¸­...',
                    'åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥'
                );
                
                // ç¼“å­˜ç»“æœ
                DataCache.set('favoriteStats', stats);
                
                // æ˜¾ç¤ºç»Ÿè®¡æ•°æ®
                statsContent.innerHTML = `
                    <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="stat-item">
                            <div class="stat-value">${stats.count || 0}</div>
                            <div class="stat-label">æ€»æ”¶è—æ•°</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${stats.total_duration_formatted || '0:00'}</div>
                            <div class="stat-label">æ”¶è—æ­Œæ›²æ€»æ—¶é•¿</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${formatSecondsToMMSS(Math.round(stats.total_duration / stats.count)) || '0:00'}</div>
                            <div class="stat-label">å¹³å‡æ­Œæ›²æ—¶é•¿</div>
                        </div>
                    </div>
                `;
            } catch (error) {
                // é”™è¯¯å·²åœ¨safeApiRequestä¸­å¤„ç†
                console.error('åŠ è½½æ”¶è—ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
                console.error('é”™è¯¯è¯¦æƒ…:', JSON.stringify(error, null, 2));
                
                // æ˜¾ç¤ºæ›´å‹å¥½çš„é”™è¯¯ä¿¡æ¯
                const statsContent = document.getElementById('favoriteStatsContent');
                if (statsContent) {
                    let errorMsg = 'åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥';
                    if (error.error) {
                        errorMsg = error.error;
                    } else if (error.message) {
                        errorMsg = error.message;
                    }
                    
                    // å¦‚æœæœ‰åŸå§‹å“åº”ï¼Œå°è¯•æå–æœ‰ç”¨çš„ä¿¡æ¯
                    if (error.rawResponse && error.rawResponse.includes('<')) {
                        errorMsg = 'æœåŠ¡å™¨è¿”å›äº†é”™è¯¯é¡µé¢ï¼Œè¯·æ£€æŸ¥APIç«¯ç‚¹æ˜¯å¦æ­£ç¡®';
                    }
                    
                    statsContent.innerHTML = `<div class="alert alert-error">${errorMsg}</div>`;
                }
            }
        }
        
        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tab) {
            currentTab = tab;
            
            // æ›´æ–°æ ‡ç­¾æ ·å¼
            document.querySelectorAll('.tab').forEach((t, index) => {
                t.classList.remove('active');
                if ((tab === 'song' && index === 0) ||
                    (tab === 'album' && index === 1) ||
                    (tab === 'songlist' && index === 2)) {
                    t.classList.add('active');
                }
            });
            
            displayCurrentTab();
        }
        
        // æ˜¾ç¤ºå½“å‰æ ‡ç­¾é¡µå†…å®¹
        function displayCurrentTab() {
            if (!favoritesData) return;
            
            const container = document.getElementById('favoriteList');
            const titleEl = document.getElementById('listTitle');
            
            switch (currentTab) {
                case 'song':
                    titleEl.textContent = 'ğŸµ æ”¶è—çš„æ­Œæ›²';
                    displaySongs(favoritesData.songs);
                    break;
                case 'album':
                    titleEl.textContent = 'ğŸ’¿ æ”¶è—çš„ä¸“è¾‘';
                    displayAlbums(favoritesData.albums);
                    break;
                case 'songlist':
                    titleEl.textContent = 'ğŸ“‹ æ”¶è—çš„æ­Œå•';
                    displaySonglists(favoritesData.songlists);
                    break;
            }
        }
        
        // æ˜¾ç¤ºæ­Œæ›²åˆ—è¡¨
        function displaySongs(data) {
            const container = document.getElementById('favoriteList');
            
            if (!data || !data.items || data.items.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">ğŸµ</div>
                        <p>è¿˜æ²¡æœ‰æ”¶è—æ­Œæ›²</p>
                        <a href="music.html" class="btn btn-primary" style="margin-top: 15px;">å»å‘ç°éŸ³ä¹</a>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <p style="color: #888; margin-bottom: 15px;">
                    å…± ${data.count} é¦–æ­Œæ›²ï¼Œæ€»æ—¶é•¿ ${data.total_duration_formatted}
                </p>
                ${data.items.map(song => `
                    <div class="song-item">
                        <div class="song-info">
                            <div class="song-title">${song.song_title}</div>
                            <div class="song-meta">${song.duration_formatted} Â· æ”¶è—äº ${song.favorite_time}</div>
                        </div>
                        <div class="song-actions">
                            <button class="btn btn-small btn-primary" onclick="playSong(${song.song_id})">æ’­æ”¾</button>
                            <button class="btn btn-small btn-secondary" onclick="viewSong(${song.song_id})">è¯¦æƒ…</button>
                            <button class="btn btn-small btn-danger" onclick="removeFavorite('song', ${song.song_id})">å–æ¶ˆæ”¶è—</button>
                        </div>
                    </div>
                `).join('')}
            `;
        }
        
        // æ˜¾ç¤ºä¸“è¾‘åˆ—è¡¨
        function displayAlbums(data) {
            const container = document.getElementById('favoriteList');
            
            if (!data || !data.items || data.items.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">ğŸ’¿</div>
                        <p>è¿˜æ²¡æœ‰æ”¶è—ä¸“è¾‘</p>
                        <a href="music.html" class="btn btn-primary" style="margin-top: 15px;">å»å‘ç°éŸ³ä¹</a>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <p style="color: #888; margin-bottom: 15px;">å…± ${data.count} å¼ ä¸“è¾‘</p>
                ${data.items.map(album => `
                    <div class="songlist-card">
                        <div class="cover">ğŸ’¿</div>
                        <div class="info" onclick="viewAlbum(${album.album_id})" style="cursor: pointer; flex: 1;">
                            <div class="title">${album.album_title}</div>
                            <div class="desc">å‘è¡Œæ—¥æœŸ: ${album.release_date || 'æœªçŸ¥'}</div>
                            <div class="stats">æ”¶è—äº ${album.favorite_time}</div>
                        </div>
                        <div>
                            <button class="btn btn-small btn-danger" onclick="removeFavorite('album', ${album.album_id})">å–æ¶ˆæ”¶è—</button>
                        </div>
                    </div>
                `).join('')}
            `;
        }
        
        // æ˜¾ç¤ºæ­Œå•åˆ—è¡¨
        function displaySonglists(data) {
            const container = document.getElementById('favoriteList');
            
            if (!data || !data.items || data.items.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">ğŸ“‹</div>
                        <p>è¿˜æ²¡æœ‰æ”¶è—æ­Œå•</p>
                        <a href="music.html" class="btn btn-primary" style="margin-top: 15px;">å»å‘ç°éŸ³ä¹</a>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <p style="color: #888; margin-bottom: 15px;">å…± ${data.count} ä¸ªæ­Œå•</p>
                ${data.items.map(list => `
                    <div class="songlist-card">
                        <div class="cover">ğŸµ</div>
                        <div class="info" onclick="viewSonglist(${list.songlist_id})" style="cursor: pointer; flex: 1;">
                            <div class="title">${list.songlist_title}</div>
                            <div class="stats">æ”¶è—äº ${list.favorite_time}</div>
                        </div>
                        <div>
                            <button class="btn btn-small btn-danger" onclick="removeFavorite('songlist', ${list.songlist_id})">å–æ¶ˆæ”¶è—</button>
                        </div>
                    </div>
                `).join('')}
            `;
        }
        
        // æ’­æ”¾æ­Œæ›²
        async function playSong(songId) {
            try {
                await PlayHistoryAPI.recordPlay(songId, 0);
                showAlert('å¼€å§‹æ’­æ”¾ï¼', 'success');
            } catch (error) {
                console.log('è®°å½•æ’­æ”¾å¤±è´¥:', error);
            }
        }
        
        // æŸ¥çœ‹è¯¦æƒ…
        function viewSong(songId) {
            window.location.href = `music.html?type=song&id=${songId}`;
        }
        
        function viewAlbum(albumId) {
            window.location.href = `music.html?type=album&id=${albumId}`;
        }
        
        function viewSonglist(songlistId) {
            window.location.href = `songlist.html?id=${songlistId}`;
        }
        
        // å–æ¶ˆæ”¶è—
        async function removeFavorite(type, id) {
            if (!confirm('ç¡®å®šè¦å–æ¶ˆæ”¶è—å—ï¼Ÿ')) {
                return;
            }
            
            try {
                await FavoriteAPI.deleteFavorite(type, id);
                showAlert('å–æ¶ˆæ”¶è—æˆåŠŸï¼', 'success');
                loadFavorites();
            } catch (error) {
                showAlert(error.error || 'å–æ¶ˆæ”¶è—å¤±è´¥', 'error');
            }
        }
        
        // æ¸²æŸ“æ—¶é•¿åˆ†å¸ƒ
        function renderDurationDistribution(distribution) {
            if (!distribution || distribution.length === 0) {
                return '<p style="color: #888; text-align: center;">æš‚æ— æ•°æ®</p>';
            }
            
            const maxValue = Math.max(...distribution.map(item => item.count));
            
            return distribution.map(item => {
                const percentage = (item.count / maxValue) * 100;
                const label = item.duration_range || 'æœªçŸ¥';
                
                return `
                    <div class="chart-bar">
                        <div class="bar-label">${label}</div>
                        <div class="bar-container">
                            <div class="bar" style="width: ${percentage}%"></div>
                        </div>
                        <div class="bar-value">${item.count}é¦–</div>
                    </div>
                `;
            }).join('');
        }
        
        // æ¸²æŸ“æµæ´¾åˆ†å¸ƒ
        function renderGenreDistribution(distribution) {
            if (!distribution || distribution.length === 0) {
                return '<p style="color: #888; text-align: center;">æš‚æ— æ•°æ®</p>';
            }
            
            return distribution.map(item => {
                const percentage = item.percentage || 0;
                const label = item.genre || 'æœªçŸ¥';
                
                return `
                    <div class="genre-item">
                        <div class="genre-label">${label}</div>
                        <div class="genre-percentage">${percentage}%</div>
                    </div>
                `;
            }).join('');
        }
        
        // æ¸²æŸ“æœˆä»½åˆ†å¸ƒ
        function renderMonthDistribution(distribution) {
            if (!distribution || distribution.length === 0) {
                return '<p style="color: #888; text-align: center;">æš‚æ— æ•°æ®</p>';
            }
            
            const maxValue = Math.max(...distribution.map(item => item.count));
            
            return distribution.map(item => {
                const percentage = (item.count / maxValue) * 100;
                const label = item.month || 'æœªçŸ¥';
                
                return `
                    <div class="month-bar">
                        <div class="month-label">${label}</div>
                        <div class="month-container">
                            <div class="month-bar-fill" style="width: ${percentage}%"></div>
                        </div>
                        <div class="month-value">${item.count}é¦–</div>
                    </div>
                `;
            }).join('');
        }
        
        // å°†ç§’æ•°è½¬æ¢ä¸ºmm:ssæ ¼å¼
        function formatSecondsToMMSS(seconds) {
            if (!seconds || isNaN(seconds)) return '0:00';
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }
        
        function showAlert(message, type) {
            const alertBox = document.getElementById('alertBox');
            alertBox.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => alertBox.innerHTML = '', 3000);
        }
    </script>
</body>
</html>
